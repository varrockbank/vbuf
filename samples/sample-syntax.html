<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>buffee - Syntax Highlighting</title>
  <script src="../buffee.js"></script>
  <script src="../extensions/statusline.js"></script>
  <script src="../extensions/syntax.js"></script>
  <link rel="stylesheet" href="../assets/reset.css">
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../themes/theme-eva.css">
  <style>
    select, input[type="file"] { margin: 4px 8px 4px 0; }
    #perf-stats, #state-display {
      font-family: monospace;
      font-size: 12px;
      color: #4ade80;
      margin-top: 12px;
      padding: 12px;
      background: #0a0a0a;
      border: 1px solid #444;
      overflow-x: auto;
    }
    #perf-stats { color: #facc15; }
  </style>
</head>
<body class="sample">
  <nav id="nav"></nav>
  <script>
    fetch('../web/navigation.html')
      .then(r => r.text())
      .then(html => document.getElementById('nav').innerHTML = html);
  </script>
  <p><a href="../index.html">home</a> / <a href="index.html">samples</a> / Syntax Highlighting</p>

  <h1>Syntax Highlighting</h1>
  <p>Regex-based tokenizer with incremental state caching.</p>

  <p>
    <label>Language:
      <select id="lang-select">
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="css">CSS</option>
        <option value="json">JSON</option>
        <option value="python">Python</option>
      </select>
    </label>
    <label><input type="checkbox" id="syntax-checkbox" checked> Syntax highlighting</label>
  </p>

  <p>
    <label>Load file: <input type="file" id="file-input"></label>
    <span id="file-size"></span>
  </p>

  <div id="perf-stats" style="display: none;"></div>

  <h2>JavaScript</h2>
  <pre>BuffeeSyntax(editor)
editor.Syntax.setLanguage('javascript')
editor.Syntax.enabled = true</pre>
  <div class="buffee buffee-themepack1-eva" id="editor">
      <textarea class="buffee-clipboard-bridge"></textarea>
      <div class="no-select buffee-elements">
        <div class="buffee-gutter"></div>
        <div class="buffee-lines" tabindex="0">
          <div class="buffee-layer-selection"></div>
          <blockquote class="buffee-layer-text"></blockquote>
          <div class="buffee-layer-elements"></div>
          <div class="buffee-cursor"></div>
        </div>
      </div>
      <div class="buffee-status">
        <div class="buffee-status-left"><span class="buffee-linecount"></span></div>
        <div class="buffee-status-right">
          Ln <span class="buffee-head-row"></span>, Col <span class="buffee-head-col"></span>
          <span class="buffee-status-divider">|</span>
          <span class="buffee-spaces"></span>
        </div>
      </div>
    </div>

  <h2>State Cache Visualization</h2>
  <p>Shows the tokenizer state at the start of each visible line (0 = normal, 1+ = special states like multiline comment/string)</p>
  <div id="state-display"></div>

  <script>
    const editorEl = document.getElementById('editor');
    const langSelect = document.getElementById('lang-select');
    const stateDisplay = document.getElementById('state-display');

    const editor = BuffeeStatusLine(new Buffee(editorEl, { rows: 10 }));

    // Initialize syntax highlighting
    BuffeeSyntax(editor);
    editor.Syntax.setLanguage('javascript');
    editor.Syntax.enabled = true;

    // Sample code for each language
    const samples = {
      javascript: `// Syntax highlighting demo
const greeting = "Hello, World!";
let count = 42;

/**
 * A multiline comment
 * spanning multiple lines
 */
async function fetchData(url) {
  const response = await fetch(url);
  const data = await response.json();
  return data;
}

class Calculator {
  constructor(value = 0) {
    this.value = value;
  }

  add(n) {
    this.value += n;
    return this;
  }

  multiply(n) {
    this.value *= n;
    return this;
  }
}

const calc = new Calculator(10);
calc.add(5).multiply(2);
console.log(\`Result: \${calc.value}\`);

// Regex example
const pattern = /\\b[A-Za-z]+\\b/gi;
const matches = "Hello World".match(pattern);

// Numbers
const hex = 0xFF;
const binary = 0b1010;
const float = 3.14159;
const scientific = 1.5e-10;`,

      html: `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sample Page</title>
  <style>
    body {
      font-family: sans-serif;
      background: #282C34;
      color: #ABB2BF;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
  <\/style>
<\/head>
<body>
  <!-- Main content -->
  <div class="container">
    <h1>Hello World</h1>
    <p id="greeting">Welcome to the page!</p>
    <button onclick="alert('Clicked!')">
      Click Me
    </button>
  </div>

  <script>
    const el = document.getElementById('greeting');
    el.textContent = 'Updated!';
  <\/script>
<\/body>
<\/html>`,

      css: `/* CSS Syntax Highlighting */
:root {
  --primary-color: #61AFEF;
  --secondary-color: #98C379;
  --background: #282C34;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--background);
  color: #ABB2BF;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

#header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 2rem;
  border-radius: 8px;
}

.button {
  display: inline-block;
  padding: 10px 20px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.button:hover {
  background-color: #4a90d9;
  transform: translateY(-2px);
}

@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}`,

      json: `{
  "name": "buffee",
  "version": "5.7.1",
  "description": "Virtual buffer text editor",
  "main": "buffee.js",
  "keywords": [
    "editor",
    "text",
    "virtual-scroll",
    "syntax-highlighting"
  ],
  "author": {
    "name": "Developer",
    "email": "dev@example.com"
  },
  "license": "MIT",
  "dependencies": {},
  "devDependencies": {
    "prettier": "^3.0.0"
  },
  "config": {
    "port": 3000,
    "debug": true,
    "features": {
      "syntax": true,
      "lineNumbers": true,
      "minimap": false
    }
  },
  "scores": [100, 95.5, 88, null],
  "active": true,
  "deprecated": false
}`,

      python: `# Python Syntax Highlighting Demo
import asyncio
from typing import List, Optional

PI = 3.14159
DEBUG = True

class Calculator:
    """A simple calculator class."""

    def __init__(self, value: float = 0):
        self.value = value
        self._history: List[float] = []

    def add(self, n: float) -> 'Calculator':
        """Add a number to the current value."""
        self._history.append(self.value)
        self.value += n
        return self

    def multiply(self, n: float) -> 'Calculator':
        self._history.append(self.value)
        self.value *= n
        return self

    @property
    def history(self) -> List[float]:
        return self._history.copy()


async def fetch_data(url: str) -> Optional[dict]:
    """Fetch data from a URL asynchronously."""
    try:
        # Simulated async operation
        await asyncio.sleep(0.1)
        return {"url": url, "status": "ok"}
    except Exception as e:
        print(f"Error: {e}")
        return None


def main():
    calc = Calculator(10)
    result = calc.add(5).multiply(2).value
    print(f"Result: {result}")

    # Numbers
    hex_val = 0xFF
    binary = 0b1010
    octal = 0o755
    scientific = 1.5e-10

    # String types
    raw = r"raw\\nstring"
    formatted = f"Value is {result}"


if __name__ == "__main__":
    main()
`
    };

    // Load initial sample
    editor.Model.text = samples.javascript;

    // Language switcher
    langSelect.addEventListener('change', () => {
      const lang = langSelect.value;
      editor.Syntax.setLanguage(lang);
      editor.Model.text = samples[lang];
      updateStateDisplay();
    });

    // Syntax checkbox
    const syntaxCheckbox = document.getElementById('syntax-checkbox');
    syntaxCheckbox.addEventListener('change', () => {
      editor.Syntax.enabled = syntaxCheckbox.checked;
      editor.Viewport.scroll(0);
    });

    // File loader
    const fileInput = document.getElementById('file-input');
    const fileSizeSpan = document.getElementById('file-size');
    const perfStats = document.getElementById('perf-stats');

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      fileSizeSpan.textContent = formatBytes(file.size);
      perfStats.style.display = 'block';
      perfStats.innerHTML = 'Loading file (streaming)...';

      const t0 = performance.now();

      const reader = file.stream().getReader();
      const decoder = new TextDecoder('utf-8');

      editor.Model.lines = [];
      let remainder = '';
      let totalLines = 0;
      let chunkCount = 0;

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const text = decoder.decode(value, { stream: true });
          const fullText = remainder + text;
          const lastNewlineIndex = fullText.lastIndexOf('\n');

          if (lastNewlineIndex !== -1) {
            const completeText = fullText.substring(0, lastNewlineIndex);
            const lines = completeText.split('\n');

            editor.Model.lines.push(...lines);
            totalLines += lines.length;
            remainder = fullText.substring(lastNewlineIndex + 1);
          } else {
            remainder = fullText;
          }

          chunkCount++;
          if (chunkCount % 20 === 0) {
            perfStats.innerHTML = `Loading... ${totalLines.toLocaleString()} lines`;
            await new Promise(r => setTimeout(r, 0));
          }
        }

        if (remainder.length > 0) {
          editor.Model.lines.push(remainder);
          totalLines++;
        }

        const t1 = performance.now();
        perfStats.innerHTML = `Loaded ${totalLines.toLocaleString()} lines in ${((t1-t0)/1000).toFixed(1)}s`;

        const t2 = performance.now();
        editor.Viewport.set(1, editor.Viewport.size);
        const t3 = performance.now();

        perfStats.innerHTML += ` | Render: ${(t3-t2).toFixed(0)}ms`;

      } finally {
        reader.releaseLock();
      }

      updateStateDisplay();
    });

    // Update state display
    function updateStateDisplay() {
      const cache = editor.Syntax.stateCache;
      const viewport = editor.Viewport;
      const lines = [];

      for (let i = 0; i < viewport.size && viewport.start + i < editor.Model.lines.length; i++) {
        const absLine = viewport.start + i;
        const state = cache[absLine] !== undefined ? cache[absLine] : '?';
        lines.push(`L${absLine + 1}: state=${state}`);
      }

      stateDisplay.textContent = lines.join(' | ');
    }

    // Update state display on scroll/edit
    const originalScroll = editor.Viewport.scroll.bind(editor.Viewport);
    editor.Viewport.scroll = function(i) {
      originalScroll(i);
      updateStateDisplay();
    };

    // Initial state display
    updateStateDisplay();

    // Update on any render (keypress, etc)
    editorEl.addEventListener('keyup', updateStateDisplay);
    editorEl.addEventListener('click', updateStateDisplay);

    // Focus editor
    editorEl.focus();
  </script>
</body>
</html>
