#!/bin/sh
# Pre-commit hook to generate minified dist file and check version bump

# Check if buffee.js is staged for commit
if git diff --cached --name-only | grep -q "^buffee.js$"; then
    # Get old version from HEAD
    OLD_VERSION=$(git show HEAD:buffee.js 2>/dev/null | grep 'this.version' | sed 's/.*"\(.*\)".*/\1/')
    # Get new version from staged file
    NEW_VERSION=$(git show :buffee.js | grep 'this.version' | sed 's/.*"\(.*\)".*/\1/')

    if [ "$OLD_VERSION" = "$NEW_VERSION" ] && [ -n "$OLD_VERSION" ]; then
        echo "✗ Error: buffee.js changed but version was not bumped"
        echo "  Current version: $OLD_VERSION"
        echo "  Please update this.version in buffee.js AND stage it."
        exit 1
    fi
fi

# Check that buffee.js and style.css versions match
BUFFEE_VERSION=$(grep 'this.version' buffee.js | sed 's/.*"\(.*\)".*/\1/')
STYLE_VERSION=$(grep '@version' style.css | sed 's/.*@version \(.*\)/\1/' | tr -d ' ')

if [ "$BUFFEE_VERSION" != "$STYLE_VERSION" ]; then
    echo "✗ Error: Version mismatch between buffee.js and style.css"
    echo "  buffee.js: $BUFFEE_VERSION"
    echo "  style.css: $STYLE_VERSION"
    echo "  Please update @version in style.css to match buffee.js"
    exit 1
fi

# Check that buffee.js and devlog.txt versions match
DEVLOG_VERSION=$(grep '^\*\* ' dev/release.txt | head -1 | sed 's/^\*\* \([^ ]*\).*/\1/')

if [ "$BUFFEE_VERSION" != "$DEVLOG_VERSION" ]; then
    echo "✗ Error: Version mismatch between buffee.js and docs/devlog.txt"
    echo "  buffee.js:     $BUFFEE_VERSION"
    echo "  release.txt:    $DEVLOG_VERSION"
    echo "  Please add a new entry to dev/release.txt for version $BUFFEE_VERSION"
    exit 1
fi

echo "Generating dist/buffee.min.js..."

# Get old sizes from HEAD (last committed version)
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    if git cat-file -e HEAD:dist/buffee.min.js 2>/dev/null; then
        OLD_SIZE=$(git show HEAD:dist/buffee.min.js | wc -c | tr -d ' ')
        OLD_GZIPPED=$(git show HEAD:dist/buffee.min.js | gzip -c | wc -c)
    else
        OLD_SIZE=0
        OLD_GZIPPED=0
    fi
else
    OLD_SIZE=0
    OLD_GZIPPED=0
fi

terser buffee.js -c -m -o dist/buffee.min.js

if [ $? -eq 0 ]; then
    NEW_SIZE=$(wc -c < dist/buffee.min.js | tr -d ' ')
    NEW_GZIPPED=$(gzip -c dist/buffee.min.js | wc -c)
    MINIFIED_KB=$(echo "$NEW_SIZE" | awk '{printf "%.2f", $1/1024}')
    GZIPPED_KB=$(echo "$NEW_GZIPPED" | awk '{printf "%.2f", $1/1024}')

    echo "✓ Minification complete"
    echo "  Minified:          ${MINIFIED_KB} KB"
    echo "  Gzipped+Minified:  ${GZIPPED_KB} KB"

    if [ $OLD_SIZE -ne 0 ]; then
        DIFF=$((NEW_SIZE - OLD_SIZE))
        DIFF_GZIPPED=$((NEW_GZIPPED - OLD_GZIPPED))
        DIFF_KB=$(echo "$DIFF" | awk '{printf "%.2f", $1/1024}')
        DIFF_GZIPPED_KB=$(echo "$DIFF_GZIPPED" | awk '{printf "%.2f", $1/1024}')

        if [ $DIFF -gt 0 ]; then
            echo "  Minified change:   +${DIFF_KB} KB"
        elif [ $DIFF -lt 0 ]; then
            echo "  Minified change:   ${DIFF_KB} KB"
        else
            echo "  Minified change:   (no change)"
        fi

        if [ $DIFF_GZIPPED -gt 0 ]; then
            echo "  Gzipped change:    +${DIFF_GZIPPED_KB} KB"
        elif [ $DIFF_GZIPPED -lt 0 ]; then
            echo "  Gzipped change:    ${DIFF_GZIPPED_KB} KB"
        else
            echo "  Gzipped change:    (no change)"
        fi
    fi

    git add dist/buffee.min.js
    exit 0
else
    echo "✗ Minification failed"
    exit 1
fi
