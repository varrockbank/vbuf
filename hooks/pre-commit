#!/bin/sh
# Pre-commit hook to generate minified dist file and check version bump

# Get current versions
BUFFEE_VERSION=$(grep 'this.version' buffee.js | sed 's/.*"\(.*\)".*/\1/')
STYLE_VERSION=$(grep '@version' style.css | sed 's/.*@version \(.*\)/\1/' | tr -d ' ')

# Check if buffee.js is staged and needs version bump
if git diff --cached --name-only | grep -q "^buffee.js$"; then
    OLD_BUFFEE_VERSION=$(git show HEAD:buffee.js 2>/dev/null | grep 'this.version' | sed 's/.*"\(.*\)".*/\1/')
    NEW_BUFFEE_VERSION=$(git show :buffee.js | grep 'this.version' | sed 's/.*"\(.*\)".*/\1/')

    if [ "$OLD_BUFFEE_VERSION" = "$NEW_BUFFEE_VERSION" ] && [ -n "$OLD_BUFFEE_VERSION" ]; then
        echo "✗ Error: buffee.js changed but version was not bumped"
        echo "  Current version: $OLD_BUFFEE_VERSION"
        echo "  style.css version: $STYLE_VERSION"
        echo "  Please bump this.version in buffee.js"
        exit 1
    fi
    BUFFEE_VERSION=$NEW_BUFFEE_VERSION
fi

# Check if style.css is staged and needs version bump
if git diff --cached --name-only | grep -q "^style.css$"; then
    OLD_STYLE_VERSION=$(git show HEAD:style.css 2>/dev/null | grep '@version' | sed 's/.*@version \(.*\)/\1/' | tr -d ' ')
    NEW_STYLE_VERSION=$(git show :style.css | grep '@version' | sed 's/.*@version \(.*\)/\1/' | tr -d ' ')

    if [ "$OLD_STYLE_VERSION" = "$NEW_STYLE_VERSION" ] && [ -n "$OLD_STYLE_VERSION" ]; then
        echo "✗ Error: style.css changed but version was not bumped"
        echo "  Current version: $OLD_STYLE_VERSION"
        echo "  buffee.js version: $BUFFEE_VERSION"
        echo "  Please bump @version in style.css"
        exit 1
    fi
    STYLE_VERSION=$NEW_STYLE_VERSION
fi

# Determine the higher version for devlog check
if [ "$(printf '%s\n' "$BUFFEE_VERSION" "$STYLE_VERSION" | sort -V | tail -1)" = "$BUFFEE_VERSION" ]; then
    MAX_VERSION=$BUFFEE_VERSION
else
    MAX_VERSION=$STYLE_VERSION
fi

# Check that devlog documents the higher version
DEVLOG_VERSION=$(grep '^\*\* ' dev/changelog.txt | head -1 | sed 's/^\*\* \([^ ]*\).*/\1/')

if [ "$MAX_VERSION" != "$DEVLOG_VERSION" ]; then
    echo "✗ Error: changelog.txt version doesn't match the highest version"
    echo "  buffee.js:     $BUFFEE_VERSION"
    echo "  style.css:     $STYLE_VERSION"
    echo "  changelog.txt: $DEVLOG_VERSION"
    echo "  Please add a new entry to dev/changelog.txt for version $MAX_VERSION"
    exit 1
fi

echo "Generating dist/buffee.min.js..."

# Get old sizes from HEAD (last committed version)
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    if git cat-file -e HEAD:dist/buffee.min.js 2>/dev/null; then
        OLD_SIZE=$(git show HEAD:dist/buffee.min.js | wc -c | tr -d ' ')
        OLD_GZIPPED=$(git show HEAD:dist/buffee.min.js | gzip -cn | wc -c)
    else
        OLD_SIZE=0
        OLD_GZIPPED=0
    fi
else
    OLD_SIZE=0
    OLD_GZIPPED=0
fi

terser buffee.js -c -m -o dist/buffee.min.js

if [ $? -eq 0 ]; then
    NEW_SIZE=$(wc -c < dist/buffee.min.js | tr -d ' ')
    NEW_GZIPPED=$(gzip -cn dist/buffee.min.js | wc -c)
    MINIFIED_KB=$(echo "$NEW_SIZE" | awk '{printf "%.2f", $1/1024}')
    GZIPPED_KB=$(echo "$NEW_GZIPPED" | awk '{printf "%.2f", $1/1024}')

    echo "✓ Minification complete"
    echo "  Minified:          ${MINIFIED_KB} KB"
    echo "  Gzipped+Minified:  ${GZIPPED_KB} KB"

    if [ $OLD_SIZE -ne 0 ]; then
        echo "DEBUG: OLD_GZIPPED=$OLD_GZIPPED NEW_GZIPPED=$NEW_GZIPPED"
        DIFF=$((NEW_SIZE - OLD_SIZE))
        DIFF_GZIPPED=$((NEW_GZIPPED - OLD_GZIPPED))
        DIFF_KB=$(echo "$DIFF" | awk '{printf "%.2f", $1/1024}')
        DIFF_GZIPPED_KB=$(echo "$DIFF_GZIPPED" | awk '{printf "%.2f", $1/1024}')

        if [ $DIFF -gt 0 ]; then
            echo "  Minified change:   +${DIFF_KB} KB"
        elif [ $DIFF -lt 0 ]; then
            echo "  Minified change:   ${DIFF_KB} KB"
        else
            echo "  Minified change:   (no change)"
        fi

        if [ $DIFF_GZIPPED -gt 0 ]; then
            echo "  Gzipped change:    +${DIFF_GZIPPED_KB} KB"
        elif [ $DIFF_GZIPPED -lt 0 ]; then
            echo "  Gzipped change:    ${DIFF_GZIPPED_KB} KB"
        else
            echo "  Gzipped change:    (no change)"
        fi
    fi

    git add dist/buffee.min.js

    # If changelog.txt is staged, append size info to the version line
    if git diff --cached --name-only | grep -q "^dev/changelog.txt$"; then
        if [ $OLD_SIZE -ne 0 ]; then
            # Format the change values with sign
            if [ $DIFF -gt 0 ]; then
                DIFF_STR="+${DIFF_KB}"
            elif [ $DIFF -lt 0 ]; then
                DIFF_STR="${DIFF_KB}"
            else
                DIFF_STR="0"
            fi
            if [ $DIFF_GZIPPED -gt 0 ]; then
                DIFF_GZ_STR="+${DIFF_GZIPPED_KB}"
            elif [ $DIFF_GZIPPED -lt 0 ]; then
                DIFF_GZ_STR="${DIFF_GZIPPED_KB}"
            else
                DIFF_GZ_STR="0"
            fi
            SIZE_INFO="  gz+min: ${GZIPPED_KB} KB (${DIFF_GZ_STR}), min: ${MINIFIED_KB} KB (${DIFF_STR})"
        else
            SIZE_INFO="  gz+min: ${GZIPPED_KB} KB, min: ${MINIFIED_KB} KB"
        fi

        # Append size info to the first version line (** X.X.X [date])
        # Find line number of first version header, then append size info
        LINE_NUM=$(grep -n '^\*\* ' dev/changelog.txt | head -1 | cut -d: -f1)
        if [ -n "$LINE_NUM" ]; then
            sed -i '' "${LINE_NUM}s/\]$/]${SIZE_INFO}/" dev/changelog.txt
        fi
        git add dev/changelog.txt
        echo "✓ Updated changelog.txt with size info"
    fi

    exit 0
else
    echo "✗ Minification failed"
    exit 1
fi
