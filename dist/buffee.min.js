function Buffee(e,t={}){this.version="11.0.5-alpha.1";const o=this,{rows:n,cols:s,spaces:l=4,logger:r,callbacks:i}=t,c=e=>a.spaces?e.replace(/\t/g," ".repeat(a.spaces)):e,a={spaces:l},h=i||{},d=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),f=d("--buffee-cell"),w=d("--buffee-padding"),u=d("--buffee-gutter-digits-initial");let p=u;const g=()=>p+d("--buffee-gutter-digits-padding"),y=(e,t)=>e.querySelector(t),m=y(e,".buffee-elements"),C=y(m,".buffee-lines"),v=y(m,".buffee-cursor"),k=y(m,".buffee-layer-text"),b=y(e,".buffee-clipboard-bridge"),L=y(m,".buffee-gutter");if(s&&(m.style.width=L?`calc(${g()+s}ch + ${4*w}px)`:`calc(${s}ch + ${2*w}px)`),n){const e=n*f+"px";k.style.height=e,L&&(L.style.height=e)}const x=[],[S,z,K]=[0,0,0].map(()=>document.createDocumentFragment()),A={row:0,col:0};let D={row:0,col:0},R=D,M=D.col;const _=this.Selection={get ordered(){return this.isForwardSelection?[R,D]:[D,R]},moveRow(e){e>0?D.row<I.lastIndex&&(D.col=Math.min(M,I.lines[++D.row].length),D.row>O.end&&(O.start=D.row-O.size+1)):D.row>0&&(D.col=Math.min(M,I.lines[--D.row].length),D.row<O.start&&(O.start=D.row)),j()},moveCol(e){1===e?D.col<I.lines[D.row].length?M=++D.col:D.row<I.lastIndex&&(M=D.col=0,++D.row>O.end&&(O.start=D.row-O.size+1)):-1===e&&(D.col>0?M=--D.col:D.row>0&&(M=D.col=I.lines[--D.row].length,D.row<O.start&&(O.start=D.row))),j()},get isSelection(){return D!==R},get isForwardSelection(){return R.row===D.row&&R.col<D.col||R.row<D.row},iosSetCursorAndRender({row:e,col:t}){const o=I.lastIndex-O.start,n=Math.min(O.size-1,o);e=Math.min(e,n);const s=O.start+e;let l=I.lines[s].length;this.setCursor({row:s,col:Math.min(t,l)}),j()},setCursor({row:e,col:t}){D.row=e,D.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=I.lines[e.row],n=e.row===I.lastIndex,s=o.slice(e.col,t.col);return t.col>=o.length&&!n?[s,""]:[s]}{const o=I.lines[e.row].slice(e.col),n=I.lines[t.row].slice(0,t.col);return[o,...I.lines.slice(e.row+1,t.row),n]}},makeCursor(){R.row=D.row,R.col=D.col,D=R},makeSelection(){D=A,D.row=R.row,D.col=R.col},moveCursorStartOfLine(){var e;M=D.col=(e=I.lines[D.row].search(/[^ ]/))>0&&e<R.col?e:0,j()},moveCursorEndOfLine(){M=D.col=I.lines[D.row].length,j()},insert(e,t=!1){if(e=c(e),this.isSelection){const[t]=this.ordered,n=this.lines.join("\n");o._internals._delete(t.row,t.col,n);const s=e.length>0?o._internals._insert(t.row,t.col,e):null;s?(D.row=t.row+s.length-1,D.col=s[s.length-1].length):(D.row=t.row,D.col=t.col+e.length),this.makeCursor()}else{const t=o._internals._insert(R.row,R.col,e);t?1===t.length?M=D.col+=e.length:(D.row+=t.length-1,M=D.col=t[t.length-1].length):M=D.col+=e.length}t||j()},delete(){if(this.isSelection)return this.insert("");if(R.col>0){const e=I.lines[R.row][R.col-1];o._internals._delete(R.row,R.col-1,e),D.col--}else if(R.row>0){const e=I.lines[R.row-1].length;o._internals._delete(R.row-1,e,"\n"),D.col=e,D.row--,D.row<O.start&&(O.start=D.row)}j()},newLine(){this.isSelection&&_.insert("",!0),o._internals._insert(R.row,R.col,"\n"),D.col=0,D.row++,D.row>O.end&&(O.start=D.row-O.size+1),j()},moveBackWord(){const e=I.lines[D.row];if(0===D.col)D.row>0&&(D.row--,D.col=I.lines[D.row].length,D.row<O.start&&(O.start=D.row));else{const t=e=>/\s/.test(e),o=e=>/[\p{L}\p{Nd}_]/u.test(e);let n=D.col;if(t(e[n])){for(;n>0&&t(e[n]);)n--;for(;n>0&&o(e[n]);)n--}else if(o(e[n]))for(;n>0&&o(e[n]);)n--;else{const t=e[n--];for(;n>0&&e[n]===t;)n--}D.col=n}j()},moveWord(){const e=I.lines[D.row],t=e.length;if(D.col===t)D.row<I.lastIndex&&(D.col=0,D.row++,D.row>O.end&&(O.start=D.row-O.size+1));else{const o=e=>/\s/.test(e),n=e=>/[\p{L}\p{Nd}_]/u.test(e);let s=D.col;if(o(e[s])){for(;s<t&&o(e[s]);)s++;for(;s<t&&n(e[s]);)s++}else if(n(e[s]))for(;s<t&&n(e[s]);)s++;else{const o=e[s++];for(;s<t&&e[s]===o;)s++}D.col=s}j()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)I.lines[o]=" ".repeat(a.spaces)+I.lines[o];e.col+=a.spaces,t.col+=a.spaces,j()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const n=o===e.row?e:t;let s=0,l=0;const r=I.lines[n.row];let i=n.col;for(;i<r.length&&" "===r.charAt(i);)i++;for(l=i-n.col,i=0;i<n.col&&" "===r.charAt(i);)i++;s=i;const c=Math.min(a.spaces,s+l);I.lines[n.row]=I.lines[n.row].slice(c),l<c&&(n.col-=c-l)}else{const e=I.lines[o];let t=0;for(let o=0;o<Math.min(a.spaces,e.length)&&" "===e.charAt(o);o++)t++;I.lines[o]=e.slice(t)}j()},partitionLine({row:e,col:t}){const o=I.lines[e];return{index:e,left:o.slice(0,t),right:o.slice(t),rightExclusive:o.slice(t+1)}}},E={onContainerRebuild:[],onRenderContent:[],onRenderComplete:[]};let $=1;const I=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=c(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,j()},splice(e,t,o=0){this.lines.splice(e,o,...t),j()},delete(e){this.lines.splice(e,1)}};const O=this.Viewport={start:0,autoFit:n?0:1,size:n||0,delta:n||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,I.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,I.lastIndex),j()},set(e,t){this.start=$clamp(e-1,0,I.lastIndex),this.delta+=t-this.size,this.size=t,j()},get lines(){return I.lines.slice(this.start,this.end+1)}};let F={lineCount:0,row:0,col:0,frameCount:0},H={lineCount:-1,row:-1,col:-1,frameCount:-1};function B(e,t,o){const n=x[e].style;null!=t&&(n.left=t+"ch"),null!=o&&(n.width=o+"ch")}function j(){F.lineCount=I.lastIndex+1,F.row=D.row,F.col=D.col,F.spaces=a.spaces,F.frameCount=H.frameCount+1;for(const[e,t]of Object.entries(h))F[e]!==H[e]&&t(F,o);const e=H;if(H=F,F=e,L){const e=Math.max(u,(O.start+O.displayLines).toString().length);e!==p&&(p=e,L.style.width=g()+"ch",s&&(m.style.width=`calc(${g()+s}ch + ${4*w}px)`))}if(O.delta){if(O.delta>0){const e=x.length;for(let t=0;t<O.delta;t++){S.appendChild(document.createElement("pre")),K.appendChild(document.createElement("div"));const o=x[e+t]=z.appendChild(document.createElement("div"));o.className="buffee-selection",o.style.top=(e+t)*f+"px"}k.appendChild(S),C.appendChild(z),L&&L.appendChild(K)}else if(O.delta<0)for(let e=0;e<-O.delta;e++)L&&L.lastChild?.remove(),k.lastChild?.remove(),x.pop()?.remove();O.delta=0;for(const e of E.onContainerRebuild)e(C,O)}for(let e=0;e<O.displayLines;e++)L&&(L.children[e].textContent=O.start+e+1),k.children[e].textContent=I.lines[O.start+e]??null,x[e].style.width="0ch";for(const e of E.onRenderContent)e(C,O);if(-1===$){v.style.visibility="hidden";for(const e of E.onRenderComplete)e(C,O);return this}const[t,n]=_.ordered,l=t.row-O.start,r=n.row-O.start;for(let e=t.row+1;e<=n.row-1;e++){const t=e-O.start;t>=0&&t<O.size&&B(t,0,I.lines[e].length+1)}if(l>=0&&l<O.size){const e=n.row===t.row?n.col-t.col:I.lines[t.row].length-t.col+1;B(l,t.col,e)}if(n.row!==t.row&&r>=0&&r<O.size){B(r,0,Math.min(n.col,I.lines[n.row].length))}const i=D.row-O.start;if(i>=0&&i<O.size){v.style.top=i*f+"px",v.style.left=D.col+"ch",v.style.visibility="visible";const e=C.getBoundingClientRect(),t=v.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const n=e.left-t.left,s=Math.ceil(n/o);C.scrollLeft-=s*o}else if(t.right>e.right){const n=t.right-e.right,s=Math.ceil(n/o);C.scrollLeft+=s*o}C.scrollLeft=Math.round(C.scrollLeft/o)*o}else v.style.visibility="hidden";for(const e of E.onRenderComplete)e(C,O);return this}if(this.use=(e,t)=>(e(this,t),this),Object.defineProperty(this,"interactive",{get:()=>$,set:e=>{$=e,j()},enumerable:!0}),this.lineHeight=f,this.Mode=a,this._internals={get head(){return D},get tail(){return R},_insert:function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return I.lines[e]=I.lines[e].slice(0,t)+o+I.lines[e].slice(t),null;const n=o.split("\n");if(1===n.length)I.lines[e]=I.lines[e].slice(0,t)+o+I.lines[e].slice(t);else{const o=I.lines[e].slice(0,t),s=I.lines[e].slice(t);I.lines[e]=o+n[0];const l=n.slice(1,-1),r=n[n.length-1]+s;I.lines.splice(e+1,0,...l,r)}return n},_delete:function(e,t,o){if(0===o.length)return;const n=o.split("\n");if(1===n.length)I.lines[e]=I.lines[e].slice(0,t)+I.lines[e].slice(t+o.length);else{const o=I.lines[e].slice(0,t),s=e+n.length-1,l=n[n.length-1].length,r=I.lines[s].slice(l);I.lines[e]=o+r,I.lines.splice(e+1,n.length-1)}},get contentOffset(){return{ch:L?g():0,px:L?3*w:w,top:w}},$e:m,$l:C,$textLayer:k,render:j,renderHooks:E,appendLines(e,t=!1){I.lines.push(...e.map(c)),t||j()}},O.autoFit){const e=()=>{const e=Math.floor(m.clientHeight/f);e>0&&e!==O.size&&(O.delta+=e-O.size,O.size=e,j())};requestAnimationFrame(e),new ResizeObserver(e).observe(m)}else j();C.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&_.insert(t)}),b.addEventListener("copy",e=>{e.preventDefault(),e.clipboardData.setData("text/plain",_.lines.join("\n"))}),b.addEventListener("cut",e=>{e.preventDefault(),e.clipboardData.setData("text/plain",_.lines.join("\n")),_.delete(),C.focus({preventScroll:!0})}),C.addEventListener("keydown",e=>{if(!e.metaKey&&!e.ctrlKey||"v"!==e.key.toLowerCase()){if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return b.focus({preventScroll:!0}),void b.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(o.History&&o.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(o.History&&o.History.redo());if(e.key.startsWith("Arrow")){if(e.preventDefault(),-1===$)return;if(e.metaKey)!e.shiftKey&&_.isSelection&&_.makeCursor(),e.shiftKey&&!_.isSelection&&_.makeSelection(),"ArrowLeft"===e.key?_.moveCursorStartOfLine():"ArrowRight"===e.key&&_.moveCursorEndOfLine();else if(e.altKey)!e.shiftKey&&_.isSelection&&_.makeCursor(),e.shiftKey&&!_.isSelection&&_.makeSelection(),"ArrowLeft"===e.key?_.moveBackWord():"ArrowRight"===e.key&&_.moveWord();else if(!e.shiftKey&&_.isSelection){if("ArrowLeft"===e.key)_.setCursor(_.ordered[0]),j();else if("ArrowRight"===e.key)_.setCursor(_.ordered[1]),j();else if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key,o=_.ordered[t?1:0],n=$clamp(o.row+(t?1:-1),0,I.lastIndex);n<O.start?O.start=n:n>O.end&&(O.start=n-O.size+1),M=Math.min(o.col,I.lines[n].length),_.setCursor({row:n,col:M}),j()}}else e.shiftKey&&!_.isSelection&&_.makeSelection(),"ArrowDown"===e.key?_.moveRow(1):"ArrowUp"===e.key?_.moveRow(-1):"ArrowLeft"===e.key?_.moveCol(-1):"ArrowRight"===e.key&&_.moveCol(1)}else 1!==$||("Backspace"===e.key?_.delete():"Enter"===e.key?_.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),_.isSelection?e.shiftKey?_.unindent():_.indent():e.shiftKey?_.unindent():_.insert(" ".repeat(a.spaces))):e.key.length>1?r.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),_.insert(e.key))))}})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}