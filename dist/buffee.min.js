function Buffee(e,{rows:t,cols:o,spaces:s=4,logger:l}={}){this.version="12.3.1-alpha.1";const n=this,r=e=>c.spaces?e.replace(/\t/g," ".repeat(c.spaces)):e,i=e=>/\s/.test(e);isWord=e=>/[\p{L}\p{Nd}_]/u.test(e);const c={spaces:s,interactive:1},a=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),h=a("--buffee-cell"),d=a("--buffee-padding"),f=a("--buffee-gutter-digits-initial");let w=-1;const u=()=>w+a("--buffee-gutter-digits-padding"),g=(e,t)=>e.querySelector(t),p=g(e,".buffee-elements"),y=g(p,".buffee-lines"),m=g(p,".buffee-cursor"),v=g(p,".buffee-layer-text"),C=g(e,".buffee-clipboard-bridge"),k=g(p,".buffee-gutter");if(o&&!k&&(p.style.width=`calc(${o}ch + ${2*d}px)`),t){const e=t*h+"px";v.style.height=e,k&&(k.style.height=e)}const L=[],[S,x,b]=[0,0,0].map(()=>document.createDocumentFragment()),z={row:0,col:0};let K={row:0,col:0},_=K,D=K.col;const M=this.Selection={get ordered(){return this.isForwardSelection?[_,K]:[K,_]},moveRow(e){e>0?K.row<$.lastIndex&&(K.col=Math.min(D,$.lines[++K.row].length),K.row>I.end&&(I.start=K.row-I.size+1)):K.row>0&&(K.col=Math.min(D,$.lines[--K.row].length),K.row<I.start&&(I.start=K.row)),W()},moveCol(e){1===e?K.col<$.lines[K.row].length?D=++K.col:K.row<$.lastIndex&&(D=K.col=0,++K.row>I.end&&(I.start=K.row-I.size+1)):-1===e&&(K.col>0?D=--K.col:K.row>0&&(D=K.col=$.lines[--K.row].length,K.row<I.start&&(I.start=K.row))),W()},get isSelection(){return K!==_},get isForwardSelection(){return _.row===K.row&&_.col<K.col||_.row<K.row},setCursor({row:e,col:t}){K.row=e,K.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=$.lines[e.row],s=e.row===$.lastIndex,l=o.slice(e.col,t.col);return t.col>=o.length&&!s?[l,""]:[l]}{const o=$.lines[e.row].slice(e.col),s=$.lines[t.row].slice(0,t.col);return[o,...$.lines.slice(e.row+1,t.row),s]}},makeCursor(){_.row=K.row,_.col=K.col,K=_},makeSelection(){K=z,K.row=_.row,K.col=_.col},moveCursorStartOfLine(){var e;D=K.col=(e=$.lines[K.row].search(/[^ ]/))>0&&e<_.col?e:0,W()},moveCursorEndOfLine(){D=K.col=$.lines[K.row].length,W()},insert(e,t=!1){if(e=r(e),this.isSelection){const[t]=this.ordered,o=this.lines.join("\n");n._._delete(t.row,t.col,o);const s=n._._insert(t.row,t.col,e);s?.length>1?(K.row=t.row+s.length-1,K.col=s[s.length-1].length):(K.row=t.row,K.col=t.col+e.length),this.makeCursor()}else{const t=n._._insert(_.row,_.col,e);t?.length>1?(K.row+=t.length-1,D=K.col=t[t.length-1].length):D=K.col+=e.length}t||W()},delete(){if(this.isSelection)return this.insert("");if(_.col>0){const e=$.lines[_.row][_.col-1];n._._delete(_.row,_.col-1,e),K.col--}else if(_.row>0){const e=$.lines[_.row-1].length;n._._delete(_.row-1,e,"\n"),K.col=e,K.row--,K.row<I.start&&(I.start=K.row)}W()},newLine(){this.isSelection&&M.insert("",!0),n._._insert(_.row,_.col,"\n"),K.col=0,K.row++,K.row>I.end&&(I.start=K.row-I.size+1),W()},moveBackWord(){const e=$.lines[K.row];if(0===K.col)K.row>0&&(K.row--,K.col=$.lines[K.row].length,K.row<I.start&&(I.start=K.row));else{let t=K.col;if(i(e[t])){for(;t>0&&i(e[t]);)t--;for(;t>0&&isWord(e[t]);)t--}else if(isWord(e[t]))for(;t>0&&isWord(e[t]);)t--;else{const o=e[t--];for(;t>0&&e[t]===o;)t--}K.col=t}W()},moveWord(){const e=$.lines[K.row],t=e.length;if(K.col===t)K.row<$.lastIndex&&(K.col=0,K.row++,K.row>I.end&&(I.start=K.row-I.size+1));else{const o=e=>/\s/.test(e),s=e=>/[\p{L}\p{Nd}_]/u.test(e);let l=K.col;if(o(e[l])){for(;l<t&&o(e[l]);)l++;for(;l<t&&s(e[l]);)l++}else if(s(e[l]))for(;l<t&&s(e[l]);)l++;else{const o=e[l++];for(;l<t&&e[l]===o;)l++}K.col=l}W()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)$.lines[o]=" ".repeat(c.spaces)+$.lines[o];e.col+=c.spaces,t.col+=c.spaces,W()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const s=o===e.row?e:t;let l=0,n=0;const r=$.lines[s.row];let i=s.col;for(;i<r.length&&" "===r.charAt(i);)i++;for(n=i-s.col,i=0;i<s.col&&" "===r.charAt(i);)i++;l=i;const a=Math.min(c.spaces,l+n);$.lines[s.row]=$.lines[s.row].slice(a),n<a&&(s.col-=a-n)}else{const e=$.lines[o];let t=0;for(;t<c.spaces&&" "===e[t];)t++;$.lines[o]=e.slice(t)}W()}},E=[],$=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=r(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,W()},splice(e,t,o=0){this.lines.splice(e,o,...t),W()},delete(e){this.lines.splice(e,1)}};const I=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,$.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,$.lastIndex),W()},set(e,t){this.start=$clamp(e-1,0,$.lastIndex),this.delta+=t-this.size,this.size=t,W()},get lines(){return $.lines.slice(this.start,this.end+1)}};let F=0;function O(e,t,o){const s=L[e].style;null!=t&&(s.left=t+"ch"),null!=o&&(s.width=o+"ch")}function W(){if(F++,k){const e=Math.max(f,(I.start+I.displayLines).toString().length);e!==w&&(w=e,k.style.width=u()+"ch",o&&(p.style.width=`calc(${u()+o}ch + ${4*d}px)`))}const e=I.delta;if(e){if(e>0){const t=L.length;for(let o=0;o<e;o++){S.appendChild(document.createElement("pre")),b.appendChild(document.createElement("div"));const e=L[t+o]=x.appendChild(document.createElement("div"));e.className="buffee-selection",e.style.top=(t+o)*h+"px"}v.appendChild(S),y.appendChild(x),k&&k.appendChild(b)}else for(let t=0;t<-e;t++)k&&k.lastChild?.remove(),v.lastChild?.remove(),L.pop()?.remove();I.delta=0}for(let e=0;e<I.displayLines;e++)k&&(k.children[e].textContent=I.start+e+1),v.children[e].textContent=$.lines[I.start+e]??null,L[e].style.width=0;if(c.interactive<0)m.style.left="-1ch";else{const[e,t]=M.ordered,o=e.row-I.start,s=t.row-I.start;for(let o=e.row+1;o<=t.row-1;o++){const e=o-I.start;e>=0&&e<I.size&&O(e,0,$.lines[o].length+1)}if(o>=0&&o<I.size){const s=t.row===e.row?t.col-e.col:$.lines[e.row].length-e.col+1;O(o,e.col,s)}if(t.row!==e.row&&s>=0&&s<I.size){O(s,0,Math.min(t.col,$.lines[t.row].length))}const l=K.row-I.start;if(l>=0&&l<I.size){m.style.top=l*h+"px",m.style.left=K.col+"ch";const e=y.getBoundingClientRect(),t=m.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const s=e.left-t.left,l=Math.ceil(s/o);y.scrollLeft-=l*o}else if(t.right>e.right){const s=t.right-e.right,l=Math.ceil(s/o);y.scrollLeft+=l*o}y.scrollLeft=Math.round(y.scrollLeft/o)*o}}for(const t of E)t(y,I,e)}if(this.lineHeight=h,this.Mode=c,this._={get head(){return K},get tail(){return _},get frameCount(){return F},get contentOffset(){return{ch:k?u():0,px:k?3*d:d,top:d}},$e:p,$l:y,$textLayer:v,render:W,renderHooks:E,_insert:function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return $.lines[e]=$.lines[e].slice(0,t)+o+$.lines[e].slice(t),null;const s=o.split("\n");if(1===s.length)$.lines[e]=$.lines[e].slice(0,t)+o+$.lines[e].slice(t);else{const o=$.lines[e].slice(0,t),l=$.lines[e].slice(t);$.lines[e]=o+s[0];const n=s.slice(1,-1),r=s[s.length-1]+l;$.lines.splice(e+1,0,...n,r)}return s},_delete:function(e,t,o){if(0===o.length)return;const s=o.split("\n");if(1===s.length)$.lines[e]=$.lines[e].slice(0,t)+$.lines[e].slice(t+o.length);else{const o=$.lines[e].slice(0,t),l=e+s.length-1,n=s[s.length-1].length,r=$.lines[l].slice(n);$.lines[e]=o+r,$.lines.splice(e+1,s.length-1)}},appendLines(e,t=!1){$.lines.push(...e.map(r)),t||W()}},I.autoFit){const e=()=>{const e=Math.floor(p.clientHeight/h);e>0&&e!==I.size&&(I.delta+=e-I.size,I.size=e,W())};requestAnimationFrame(e),new ResizeObserver(e).observe(p)}else W();y.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&M.insert(t)});const A=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",M.lines.join("\n"))};C.addEventListener("copy",A),C.addEventListener("cut",e=>{A(e),M.delete(),y.focus({preventScroll:!0})});const H={ArrowDown:2,ArrowUp:-2,ArrowLeft:-1,ArrowRight:1};y.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"v"===e.key.toLowerCase())return;if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return C.focus({preventScroll:!0}),void C.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(n.History&&n.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(n.History&&n.History.redo());const t=H[e.key]||0;if(t){const o=t>>31|1;if(e.preventDefault(),-1===c.interactive)return;if(e.metaKey)!e.shiftKey&&M.isSelection&&M.makeCursor(),e.shiftKey&&!M.isSelection&&M.makeSelection(),t%2&&M[o>0?"moveCursorEndOfLine":"moveCursorStartOfLine"]();else if(e.altKey)!e.shiftKey&&M.isSelection&&M.makeCursor(),e.shiftKey&&!M.isSelection&&M.makeSelection(),t%2&&M[o>0?"moveWord":"moveBackWord"]();else if(!e.shiftKey&&M.isSelection)if(t%2)M.setCursor(M.ordered[o>0|0]),W();else{const e=M.ordered[o>0|0],t=$clamp(e.row+o,0,$.lastIndex);t<I.start?I.start=t:t>I.end&&(I.start=t-I.size+1),D=Math.min(e.col,$.lines[t].length),M.setCursor({row:t,col:D}),W()}else e.shiftKey&&!M.isSelection&&M.makeSelection(),M[t%2?"moveCol":"moveRow"](o)}else 1!==c.interactive||("Backspace"===e.key?M.delete():"Enter"===e.key?M.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),e.shiftKey?M.unindent():M.isSelection?M.indent():M.insert(" ".repeat(c.spaces))):e.key.length>1?l.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),M.insert(e.key))))})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}