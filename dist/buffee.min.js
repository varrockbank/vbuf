function Buffee(e,{rows:t,cols:o,spaces:s=4,logger:n,callbacks:l}={}){this.version="11.1.0-alpha.1";const i=this,r=e=>c.spaces?e.replace(/\t/g," ".repeat(c.spaces)):e,c={spaces:s,interactive:1},a=l||{},h=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),d=h("--buffee-cell"),f=h("--buffee-padding"),w=h("--buffee-gutter-digits-initial");let u=w;const p=()=>u+h("--buffee-gutter-digits-padding"),g=(e,t)=>e.querySelector(t),y=g(e,".buffee-elements"),m=g(y,".buffee-lines"),C=g(y,".buffee-cursor"),v=g(y,".buffee-layer-text"),k=g(e,".buffee-clipboard-bridge"),b=g(y,".buffee-gutter");if(o&&(y.style.width=b?`calc(${p()+o}ch + ${4*f}px)`:`calc(${o}ch + ${2*f}px)`),t){const e=t*d+"px";v.style.height=e,b&&(b.style.height=e)}const L=[],[x,S,z]=[0,0,0].map(()=>document.createDocumentFragment()),K={row:0,col:0};let A={row:0,col:0},_=A,D=A.col;const R=this.Selection={get ordered(){return this.isForwardSelection?[_,A]:[A,_]},moveRow(e){e>0?A.row<E.lastIndex&&(A.col=Math.min(D,E.lines[++A.row].length),A.row>$.end&&($.start=A.row-$.size+1)):A.row>0&&(A.col=Math.min(D,E.lines[--A.row].length),A.row<$.start&&($.start=A.row)),j()},moveCol(e){1===e?A.col<E.lines[A.row].length?D=++A.col:A.row<E.lastIndex&&(D=A.col=0,++A.row>$.end&&($.start=A.row-$.size+1)):-1===e&&(A.col>0?D=--A.col:A.row>0&&(D=A.col=E.lines[--A.row].length,A.row<$.start&&($.start=A.row))),j()},get isSelection(){return A!==_},get isForwardSelection(){return _.row===A.row&&_.col<A.col||_.row<A.row},iosSetCursorAndRender({row:e,col:t}){const o=E.lastIndex-$.start,s=Math.min($.size-1,o);e=Math.min(e,s);const n=$.start+e;let l=E.lines[n].length;this.setCursor({row:n,col:Math.min(t,l)}),j()},setCursor({row:e,col:t}){A.row=e,A.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=E.lines[e.row],s=e.row===E.lastIndex,n=o.slice(e.col,t.col);return t.col>=o.length&&!s?[n,""]:[n]}{const o=E.lines[e.row].slice(e.col),s=E.lines[t.row].slice(0,t.col);return[o,...E.lines.slice(e.row+1,t.row),s]}},makeCursor(){_.row=A.row,_.col=A.col,A=_},makeSelection(){A=K,A.row=_.row,A.col=_.col},moveCursorStartOfLine(){var e;D=A.col=(e=E.lines[A.row].search(/[^ ]/))>0&&e<_.col?e:0,j()},moveCursorEndOfLine(){D=A.col=E.lines[A.row].length,j()},insert(e,t=!1){if(e=r(e),this.isSelection){const[t]=this.ordered,o=this.lines.join("\n");i._delete(t.row,t.col,o);const s=e.length>0?i._insert(t.row,t.col,e):null;s&&1!==s.length?(A.row=t.row+s.length-1,A.col=s[s.length-1].length):(A.row=t.row,A.col=t.col+e.length),this.makeCursor()}else{const t=i._insert(_.row,_.col,e);t?1===t.length?D=A.col+=e.length:(A.row+=t.length-1,D=A.col=t[t.length-1].length):D=A.col+=e.length}t||j()},delete(){if(this.isSelection)return this.insert("");if(_.col>0){const e=E.lines[_.row][_.col-1];i._delete(_.row,_.col-1,e),A.col--}else if(_.row>0){const e=E.lines[_.row-1].length;i._delete(_.row-1,e,"\n"),A.col=e,A.row--,A.row<$.start&&($.start=A.row)}j()},newLine(){this.isSelection&&R.insert("",!0),i._insert(_.row,_.col,"\n"),A.col=0,A.row++,A.row>$.end&&($.start=A.row-$.size+1),j()},moveBackWord(){const e=E.lines[A.row];if(0===A.col)A.row>0&&(A.row--,A.col=E.lines[A.row].length,A.row<$.start&&($.start=A.row));else{const t=e=>/\s/.test(e),o=e=>/[\p{L}\p{Nd}_]/u.test(e);let s=A.col;if(t(e[s])){for(;s>0&&t(e[s]);)s--;for(;s>0&&o(e[s]);)s--}else if(o(e[s]))for(;s>0&&o(e[s]);)s--;else{const t=e[s--];for(;s>0&&e[s]===t;)s--}A.col=s}j()},moveWord(){const e=E.lines[A.row],t=e.length;if(A.col===t)A.row<E.lastIndex&&(A.col=0,A.row++,A.row>$.end&&($.start=A.row-$.size+1));else{const o=e=>/\s/.test(e),s=e=>/[\p{L}\p{Nd}_]/u.test(e);let n=A.col;if(o(e[n])){for(;n<t&&o(e[n]);)n++;for(;n<t&&s(e[n]);)n++}else if(s(e[n]))for(;n<t&&s(e[n]);)n++;else{const o=e[n++];for(;n<t&&e[n]===o;)n++}A.col=n}j()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)E.lines[o]=" ".repeat(c.spaces)+E.lines[o];e.col+=c.spaces,t.col+=c.spaces,j()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const s=o===e.row?e:t;let n=0,l=0;const i=E.lines[s.row];let r=s.col;for(;r<i.length&&" "===i.charAt(r);)r++;for(l=r-s.col,r=0;r<s.col&&" "===i.charAt(r);)r++;n=r;const a=Math.min(c.spaces,n+l);E.lines[s.row]=E.lines[s.row].slice(a),l<a&&(s.col-=a-l)}else{const e=E.lines[o];let t=0;for(let o=0;o<Math.min(c.spaces,e.length)&&" "===e.charAt(o);o++)t++;E.lines[o]=e.slice(t)}j()},partitionLine({row:e,col:t}){const o=E.lines[e];return{index:e,left:o.slice(0,t),right:o.slice(t),rightExclusive:o.slice(t+1)}}},M={onContainerRebuild:[],onRenderContent:[],onRenderComplete:[]},E=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=r(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,j()},splice(e,t,o=0){this.lines.splice(e,o,...t),j()},delete(e){this.lines.splice(e,1)}};const $=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,E.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,E.lastIndex),j()},set(e,t){this.start=$clamp(e-1,0,E.lastIndex),this.delta+=t-this.size,this.size=t,j()},get lines(){return E.lines.slice(this.start,this.end+1)}};let I={lineCount:0,row:0,col:0,frameCount:0},O={lineCount:-1,row:-1,col:-1,frameCount:-1};function F(e,t,o){const s=L[e].style;null!=t&&(s.left=t+"ch"),null!=o&&(s.width=o+"ch")}function j(){I.lineCount=E.lastIndex+1,I.row=A.row,I.col=A.col,I.spaces=c.spaces,I.frameCount=O.frameCount+1;for(const[e,t]of Object.entries(a))I[e]!==O[e]&&t(I,i);const e=O;if(O=I,I=e,b){const e=Math.max(w,($.start+$.displayLines).toString().length);e!==u&&(u=e,b.style.width=p()+"ch",o&&(y.style.width=`calc(${p()+o}ch + ${4*f}px)`))}if($.delta){if($.delta>0){const e=L.length;for(let t=0;t<$.delta;t++){x.appendChild(document.createElement("pre")),z.appendChild(document.createElement("div"));const o=L[e+t]=S.appendChild(document.createElement("div"));o.className="buffee-selection",o.style.top=(e+t)*d+"px"}v.appendChild(x),m.appendChild(S),b&&b.appendChild(z)}else if($.delta<0)for(let e=0;e<-$.delta;e++)b&&b.lastChild?.remove(),v.lastChild?.remove(),L.pop()?.remove();$.delta=0;for(const e of M.onContainerRebuild)e(m,$)}for(let e=0;e<$.displayLines;e++)b&&(b.children[e].textContent=$.start+e+1),v.children[e].textContent=E.lines[$.start+e]??null,L[e].style.width="0ch";for(const e of M.onRenderContent)e(m,$);if(-1===c.interactive){C.style.visibility="hidden";for(const e of M.onRenderComplete)e(m,$);return this}const[t,s]=R.ordered,n=t.row-$.start,l=s.row-$.start;for(let e=t.row+1;e<=s.row-1;e++){const t=e-$.start;t>=0&&t<$.size&&F(t,0,E.lines[e].length+1)}if(n>=0&&n<$.size){const e=s.row===t.row?s.col-t.col:E.lines[t.row].length-t.col+1;F(n,t.col,e)}if(s.row!==t.row&&l>=0&&l<$.size){F(l,0,Math.min(s.col,E.lines[s.row].length))}const r=A.row-$.start;if(r>=0&&r<$.size){C.style.top=r*d+"px",C.style.left=A.col+"ch",C.style.visibility="visible";const e=m.getBoundingClientRect(),t=C.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const s=e.left-t.left,n=Math.ceil(s/o);m.scrollLeft-=n*o}else if(t.right>e.right){const s=t.right-e.right,n=Math.ceil(s/o);m.scrollLeft+=n*o}m.scrollLeft=Math.round(m.scrollLeft/o)*o}else C.style.visibility="hidden";for(const e of M.onRenderComplete)e(m,$);return this}if(this.use=(e,t)=>(e(this,t),this),this.lineHeight=d,this.Mode=c,Object.defineProperty(this,"_head",{get:()=>A}),Object.defineProperty(this,"_tail",{get:()=>_}),this._insert=function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return E.lines[e]=E.lines[e].slice(0,t)+o+E.lines[e].slice(t),null;const s=o.split("\n");if(1===s.length)E.lines[e]=E.lines[e].slice(0,t)+o+E.lines[e].slice(t);else{const o=E.lines[e].slice(0,t),n=E.lines[e].slice(t);E.lines[e]=o+s[0];const l=s.slice(1,-1),i=s[s.length-1]+n;E.lines.splice(e+1,0,...l,i)}return s},this._delete=function(e,t,o){if(0===o.length)return;const s=o.split("\n");if(1===s.length)E.lines[e]=E.lines[e].slice(0,t)+E.lines[e].slice(t+o.length);else{const o=E.lines[e].slice(0,t),n=e+s.length-1,l=s[s.length-1].length,i=E.lines[n].slice(l);E.lines[e]=o+i,E.lines.splice(e+1,s.length-1)}},Object.defineProperty(this,"_contentOffset",{get:()=>({ch:b?p():0,px:b?3*f:f,top:f})}),this._$e=y,this._$l=m,this._$textLayer=v,this._render=j,this._renderHooks=M,this._appendLines=function(e,t=!1){E.lines.push(...e.map(r)),t||j()},$.autoFit){const e=()=>{const e=Math.floor(y.clientHeight/d);e>0&&e!==$.size&&($.delta+=e-$.size,$.size=e,j())};requestAnimationFrame(e),new ResizeObserver(e).observe(y)}else j();m.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&R.insert(t)}),k.addEventListener("copy",e=>{e.preventDefault(),e.clipboardData.setData("text/plain",R.lines.join("\n"))}),k.addEventListener("cut",e=>{e.preventDefault(),e.clipboardData.setData("text/plain",R.lines.join("\n")),R.delete(),m.focus({preventScroll:!0})}),m.addEventListener("keydown",e=>{if(!e.metaKey&&!e.ctrlKey||"v"!==e.key.toLowerCase()){if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return k.focus({preventScroll:!0}),void k.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(i.History&&i.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(i.History&&i.History.redo());if(e.key.startsWith("Arrow")){if(e.preventDefault(),-1===c.interactive)return;if(e.metaKey)!e.shiftKey&&R.isSelection&&R.makeCursor(),e.shiftKey&&!R.isSelection&&R.makeSelection(),"ArrowLeft"===e.key?R.moveCursorStartOfLine():"ArrowRight"===e.key&&R.moveCursorEndOfLine();else if(e.altKey)!e.shiftKey&&R.isSelection&&R.makeCursor(),e.shiftKey&&!R.isSelection&&R.makeSelection(),"ArrowLeft"===e.key?R.moveBackWord():"ArrowRight"===e.key&&R.moveWord();else if(!e.shiftKey&&R.isSelection){if("ArrowLeft"===e.key)R.setCursor(R.ordered[0]),j();else if("ArrowRight"===e.key)R.setCursor(R.ordered[1]),j();else if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key,o=R.ordered[t?1:0],s=$clamp(o.row+(t?1:-1),0,E.lastIndex);s<$.start?$.start=s:s>$.end&&($.start=s-$.size+1),D=Math.min(o.col,E.lines[s].length),R.setCursor({row:s,col:D}),j()}}else e.shiftKey&&!R.isSelection&&R.makeSelection(),"ArrowDown"===e.key?R.moveRow(1):"ArrowUp"===e.key?R.moveRow(-1):"ArrowLeft"===e.key?R.moveCol(-1):"ArrowRight"===e.key&&R.moveCol(1)}else 1!==c.interactive||("Backspace"===e.key?R.delete():"Enter"===e.key?R.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),R.isSelection?e.shiftKey?R.unindent():R.indent():e.shiftKey?R.unindent():R.insert(" ".repeat(c.spaces))):e.key.length>1?n.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),R.insert(e.key))))}})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}