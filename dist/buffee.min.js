function Buffee(e,t={}){this.version="11.0.8-alpha.1";const o=this,{rows:s,cols:n,spaces:l=4,logger:i,callbacks:r}=t,c=e=>a.spaces?e.replace(/\t/g," ".repeat(a.spaces)):e,a={spaces:l,interactive:1},h=r||{},d=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),f=d("--buffee-cell"),w=d("--buffee-padding"),u=d("--buffee-gutter-digits-initial");let p=u;const g=()=>p+d("--buffee-gutter-digits-padding"),y=(e,t)=>e.querySelector(t),m=y(e,".buffee-elements"),C=y(m,".buffee-lines"),v=y(m,".buffee-cursor"),k=y(m,".buffee-layer-text"),b=y(e,".buffee-clipboard-bridge"),L=y(m,".buffee-gutter");if(n&&(m.style.width=L?`calc(${g()+n}ch + ${4*w}px)`:`calc(${n}ch + ${2*w}px)`),s){const e=s*f+"px";k.style.height=e,L&&(L.style.height=e)}const x=[],[S,z,K]=[0,0,0].map(()=>document.createDocumentFragment()),A={row:0,col:0};let _={row:0,col:0},D=_,R=_.col;const M=this.Selection={get ordered(){return this.isForwardSelection?[D,_]:[_,D]},moveRow(e){e>0?_.row<$.lastIndex&&(_.col=Math.min(R,$.lines[++_.row].length),_.row>I.end&&(I.start=_.row-I.size+1)):_.row>0&&(_.col=Math.min(R,$.lines[--_.row].length),_.row<I.start&&(I.start=_.row)),H()},moveCol(e){1===e?_.col<$.lines[_.row].length?R=++_.col:_.row<$.lastIndex&&(R=_.col=0,++_.row>I.end&&(I.start=_.row-I.size+1)):-1===e&&(_.col>0?R=--_.col:_.row>0&&(R=_.col=$.lines[--_.row].length,_.row<I.start&&(I.start=_.row))),H()},get isSelection(){return _!==D},get isForwardSelection(){return D.row===_.row&&D.col<_.col||D.row<_.row},iosSetCursorAndRender({row:e,col:t}){const o=$.lastIndex-I.start,s=Math.min(I.size-1,o);e=Math.min(e,s);const n=I.start+e;let l=$.lines[n].length;this.setCursor({row:n,col:Math.min(t,l)}),H()},setCursor({row:e,col:t}){_.row=e,_.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=$.lines[e.row],s=e.row===$.lastIndex,n=o.slice(e.col,t.col);return t.col>=o.length&&!s?[n,""]:[n]}{const o=$.lines[e.row].slice(e.col),s=$.lines[t.row].slice(0,t.col);return[o,...$.lines.slice(e.row+1,t.row),s]}},makeCursor(){D.row=_.row,D.col=_.col,_=D},makeSelection(){_=A,_.row=D.row,_.col=D.col},moveCursorStartOfLine(){var e;R=_.col=(e=$.lines[_.row].search(/[^ ]/))>0&&e<D.col?e:0,H()},moveCursorEndOfLine(){R=_.col=$.lines[_.row].length,H()},insert(e,t=!1){if(e=c(e),this.isSelection){const[t]=this.ordered,s=this.lines.join("\n");o._delete(t.row,t.col,s);const n=e.length>0?o._insert(t.row,t.col,e):null;n&&1!==n.length?(_.row=t.row+n.length-1,_.col=n[n.length-1].length):(_.row=t.row,_.col=t.col+e.length),this.makeCursor()}else{const t=o._insert(D.row,D.col,e);t?1===t.length?R=_.col+=e.length:(_.row+=t.length-1,R=_.col=t[t.length-1].length):R=_.col+=e.length}t||H()},delete(){if(this.isSelection)return this.insert("");if(D.col>0){const e=$.lines[D.row][D.col-1];o._delete(D.row,D.col-1,e),_.col--}else if(D.row>0){const e=$.lines[D.row-1].length;o._delete(D.row-1,e,"\n"),_.col=e,_.row--,_.row<I.start&&(I.start=_.row)}H()},newLine(){this.isSelection&&M.insert("",!0),o._insert(D.row,D.col,"\n"),_.col=0,_.row++,_.row>I.end&&(I.start=_.row-I.size+1),H()},moveBackWord(){const e=$.lines[_.row];if(0===_.col)_.row>0&&(_.row--,_.col=$.lines[_.row].length,_.row<I.start&&(I.start=_.row));else{const t=e=>/\s/.test(e),o=e=>/[\p{L}\p{Nd}_]/u.test(e);let s=_.col;if(t(e[s])){for(;s>0&&t(e[s]);)s--;for(;s>0&&o(e[s]);)s--}else if(o(e[s]))for(;s>0&&o(e[s]);)s--;else{const t=e[s--];for(;s>0&&e[s]===t;)s--}_.col=s}H()},moveWord(){const e=$.lines[_.row],t=e.length;if(_.col===t)_.row<$.lastIndex&&(_.col=0,_.row++,_.row>I.end&&(I.start=_.row-I.size+1));else{const o=e=>/\s/.test(e),s=e=>/[\p{L}\p{Nd}_]/u.test(e);let n=_.col;if(o(e[n])){for(;n<t&&o(e[n]);)n++;for(;n<t&&s(e[n]);)n++}else if(s(e[n]))for(;n<t&&s(e[n]);)n++;else{const o=e[n++];for(;n<t&&e[n]===o;)n++}_.col=n}H()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)$.lines[o]=" ".repeat(a.spaces)+$.lines[o];e.col+=a.spaces,t.col+=a.spaces,H()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const s=o===e.row?e:t;let n=0,l=0;const i=$.lines[s.row];let r=s.col;for(;r<i.length&&" "===i.charAt(r);)r++;for(l=r-s.col,r=0;r<s.col&&" "===i.charAt(r);)r++;n=r;const c=Math.min(a.spaces,n+l);$.lines[s.row]=$.lines[s.row].slice(c),l<c&&(s.col-=c-l)}else{const e=$.lines[o];let t=0;for(let o=0;o<Math.min(a.spaces,e.length)&&" "===e.charAt(o);o++)t++;$.lines[o]=e.slice(t)}H()},partitionLine({row:e,col:t}){const o=$.lines[e];return{index:e,left:o.slice(0,t),right:o.slice(t),rightExclusive:o.slice(t+1)}}},E={onContainerRebuild:[],onRenderContent:[],onRenderComplete:[]},$=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=c(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,H()},splice(e,t,o=0){this.lines.splice(e,o,...t),H()},delete(e){this.lines.splice(e,1)}};const I=this.Viewport={start:0,autoFit:s?0:1,size:s||0,delta:s||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,$.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,$.lastIndex),H()},set(e,t){this.start=$clamp(e-1,0,$.lastIndex),this.delta+=t-this.size,this.size=t,H()},get lines(){return $.lines.slice(this.start,this.end+1)}};let O={lineCount:0,row:0,col:0,frameCount:0},F={lineCount:-1,row:-1,col:-1,frameCount:-1};function j(e,t,o){const s=x[e].style;null!=t&&(s.left=t+"ch"),null!=o&&(s.width=o+"ch")}function H(){O.lineCount=$.lastIndex+1,O.row=_.row,O.col=_.col,O.spaces=a.spaces,O.frameCount=F.frameCount+1;for(const[e,t]of Object.entries(h))O[e]!==F[e]&&t(O,o);const e=F;if(F=O,O=e,L){const e=Math.max(u,(I.start+I.displayLines).toString().length);e!==p&&(p=e,L.style.width=g()+"ch",n&&(m.style.width=`calc(${g()+n}ch + ${4*w}px)`))}if(I.delta){if(I.delta>0){const e=x.length;for(let t=0;t<I.delta;t++){S.appendChild(document.createElement("pre")),K.appendChild(document.createElement("div"));const o=x[e+t]=z.appendChild(document.createElement("div"));o.className="buffee-selection",o.style.top=(e+t)*f+"px"}k.appendChild(S),C.appendChild(z),L&&L.appendChild(K)}else if(I.delta<0)for(let e=0;e<-I.delta;e++)L&&L.lastChild?.remove(),k.lastChild?.remove(),x.pop()?.remove();I.delta=0;for(const e of E.onContainerRebuild)e(C,I)}for(let e=0;e<I.displayLines;e++)L&&(L.children[e].textContent=I.start+e+1),k.children[e].textContent=$.lines[I.start+e]??null,x[e].style.width="0ch";for(const e of E.onRenderContent)e(C,I);if(-1===a.interactive){v.style.visibility="hidden";for(const e of E.onRenderComplete)e(C,I);return this}const[t,s]=M.ordered,l=t.row-I.start,i=s.row-I.start;for(let e=t.row+1;e<=s.row-1;e++){const t=e-I.start;t>=0&&t<I.size&&j(t,0,$.lines[e].length+1)}if(l>=0&&l<I.size){const e=s.row===t.row?s.col-t.col:$.lines[t.row].length-t.col+1;j(l,t.col,e)}if(s.row!==t.row&&i>=0&&i<I.size){j(i,0,Math.min(s.col,$.lines[s.row].length))}const r=_.row-I.start;if(r>=0&&r<I.size){v.style.top=r*f+"px",v.style.left=_.col+"ch",v.style.visibility="visible";const e=C.getBoundingClientRect(),t=v.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const s=e.left-t.left,n=Math.ceil(s/o);C.scrollLeft-=n*o}else if(t.right>e.right){const s=t.right-e.right,n=Math.ceil(s/o);C.scrollLeft+=n*o}C.scrollLeft=Math.round(C.scrollLeft/o)*o}else v.style.visibility="hidden";for(const e of E.onRenderComplete)e(C,I);return this}if(this.use=(e,t)=>(e(this,t),this),this.lineHeight=f,this.Mode=a,Object.defineProperty(this,"_head",{get:()=>_}),Object.defineProperty(this,"_tail",{get:()=>D}),this._insert=function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return $.lines[e]=$.lines[e].slice(0,t)+o+$.lines[e].slice(t),null;const s=o.split("\n");if(1===s.length)$.lines[e]=$.lines[e].slice(0,t)+o+$.lines[e].slice(t);else{const o=$.lines[e].slice(0,t),n=$.lines[e].slice(t);$.lines[e]=o+s[0];const l=s.slice(1,-1),i=s[s.length-1]+n;$.lines.splice(e+1,0,...l,i)}return s},this._delete=function(e,t,o){if(0===o.length)return;const s=o.split("\n");if(1===s.length)$.lines[e]=$.lines[e].slice(0,t)+$.lines[e].slice(t+o.length);else{const o=$.lines[e].slice(0,t),n=e+s.length-1,l=s[s.length-1].length,i=$.lines[n].slice(l);$.lines[e]=o+i,$.lines.splice(e+1,s.length-1)}},Object.defineProperty(this,"_contentOffset",{get:()=>({ch:L?g():0,px:L?3*w:w,top:w})}),this._$e=m,this._$l=C,this._$textLayer=k,this._render=H,this._renderHooks=E,this._appendLines=function(e,t=!1){$.lines.push(...e.map(c)),t||H()},I.autoFit){const e=()=>{const e=Math.floor(m.clientHeight/f);e>0&&e!==I.size&&(I.delta+=e-I.size,I.size=e,H())};requestAnimationFrame(e),new ResizeObserver(e).observe(m)}else H();C.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&M.insert(t)}),b.addEventListener("copy",e=>{e.preventDefault(),e.clipboardData.setData("text/plain",M.lines.join("\n"))}),b.addEventListener("cut",e=>{e.preventDefault(),e.clipboardData.setData("text/plain",M.lines.join("\n")),M.delete(),C.focus({preventScroll:!0})}),C.addEventListener("keydown",e=>{if(!e.metaKey&&!e.ctrlKey||"v"!==e.key.toLowerCase()){if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return b.focus({preventScroll:!0}),void b.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(o.History&&o.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(o.History&&o.History.redo());if(e.key.startsWith("Arrow")){if(e.preventDefault(),-1===a.interactive)return;if(e.metaKey)!e.shiftKey&&M.isSelection&&M.makeCursor(),e.shiftKey&&!M.isSelection&&M.makeSelection(),"ArrowLeft"===e.key?M.moveCursorStartOfLine():"ArrowRight"===e.key&&M.moveCursorEndOfLine();else if(e.altKey)!e.shiftKey&&M.isSelection&&M.makeCursor(),e.shiftKey&&!M.isSelection&&M.makeSelection(),"ArrowLeft"===e.key?M.moveBackWord():"ArrowRight"===e.key&&M.moveWord();else if(!e.shiftKey&&M.isSelection){if("ArrowLeft"===e.key)M.setCursor(M.ordered[0]),H();else if("ArrowRight"===e.key)M.setCursor(M.ordered[1]),H();else if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key,o=M.ordered[t?1:0],s=$clamp(o.row+(t?1:-1),0,$.lastIndex);s<I.start?I.start=s:s>I.end&&(I.start=s-I.size+1),R=Math.min(o.col,$.lines[s].length),M.setCursor({row:s,col:R}),H()}}else e.shiftKey&&!M.isSelection&&M.makeSelection(),"ArrowDown"===e.key?M.moveRow(1):"ArrowUp"===e.key?M.moveRow(-1):"ArrowLeft"===e.key?M.moveCol(-1):"ArrowRight"===e.key&&M.moveCol(1)}else 1!==a.interactive||("Backspace"===e.key?M.delete():"Enter"===e.key?M.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),M.isSelection?e.shiftKey?M.unindent():M.indent():e.shiftKey?M.unindent():M.insert(" ".repeat(a.spaces))):e.key.length>1?i.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),M.insert(e.key))))}})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}