function Buffee(e,{rows:t,cols:o,spaces:n=4,logger:l,callbacks:s}={}){this.version="12.0.0-alpha";const r=this,i=e=>c.spaces?e.replace(/\t/g," ".repeat(c.spaces)):e,c={spaces:n,interactive:1},a=Object.entries(s||{}),h=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),d=h("--buffee-cell"),f=h("--buffee-padding"),w=h("--buffee-gutter-digits-initial");let u=-1;const g=()=>u+h("--buffee-gutter-digits-padding"),p=(e,t)=>e.querySelector(t),y=p(e,".buffee-elements"),m=p(y,".buffee-lines"),C=p(y,".buffee-cursor"),v=p(y,".buffee-layer-text"),k=p(e,".buffee-clipboard-bridge"),b=p(y,".buffee-gutter");if(o&&!b&&(y.style.width=`calc(${o}ch + ${2*f}px)`),t){const e=t*d+"px";v.style.height=e,b&&(b.style.height=e)}const L=[],[x,S,z]=[0,0,0].map(()=>document.createDocumentFragment()),K={row:0,col:0};let M={row:0,col:0},D=M,E=M.col;const R=this.Selection={get ordered(){return this.isForwardSelection?[D,M]:[M,D]},moveRow(e){e>0?M.row<$.lastIndex&&(M.col=Math.min(E,$.lines[++M.row].length),M.row>O.end&&(O.start=M.row-O.size+1)):M.row>0&&(M.col=Math.min(E,$.lines[--M.row].length),M.row<O.start&&(O.start=M.row)),H()},moveCol(e){1===e?M.col<$.lines[M.row].length?E=++M.col:M.row<$.lastIndex&&(E=M.col=0,++M.row>O.end&&(O.start=M.row-O.size+1)):-1===e&&(M.col>0?E=--M.col:M.row>0&&(E=M.col=$.lines[--M.row].length,M.row<O.start&&(O.start=M.row))),H()},get isSelection(){return M!==D},get isForwardSelection(){return D.row===M.row&&D.col<M.col||D.row<M.row},setCursor({row:e,col:t}){M.row=e,M.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=$.lines[e.row],n=e.row===$.lastIndex,l=o.slice(e.col,t.col);return t.col>=o.length&&!n?[l,""]:[l]}{const o=$.lines[e.row].slice(e.col),n=$.lines[t.row].slice(0,t.col);return[o,...$.lines.slice(e.row+1,t.row),n]}},makeCursor(){D.row=M.row,D.col=M.col,M=D},makeSelection(){M=K,M.row=D.row,M.col=D.col},moveCursorStartOfLine(){var e;E=M.col=(e=$.lines[M.row].search(/[^ ]/))>0&&e<D.col?e:0,H()},moveCursorEndOfLine(){E=M.col=$.lines[M.row].length,H()},insert(e,t=!1){if(e=i(e),this.isSelection){const[t]=this.ordered,o=this.lines.join("\n");r._.delete(t.row,t.col,o);const n=e.length>0?r._.insert(t.row,t.col,e):null;n&&1!==n.length?(M.row=t.row+n.length-1,M.col=n[n.length-1].length):(M.row=t.row,M.col=t.col+e.length),this.makeCursor()}else{const t=r._.insert(D.row,D.col,e);t?1===t.length?E=M.col+=e.length:(M.row+=t.length-1,E=M.col=t[t.length-1].length):E=M.col+=e.length}t||H()},delete(){if(this.isSelection)return this.insert("");if(D.col>0){const e=$.lines[D.row][D.col-1];r._.delete(D.row,D.col-1,e),M.col--}else if(D.row>0){const e=$.lines[D.row-1].length;r._.delete(D.row-1,e,"\n"),M.col=e,M.row--,M.row<O.start&&(O.start=M.row)}H()},newLine(){this.isSelection&&R.insert("",!0),r._.insert(D.row,D.col,"\n"),M.col=0,M.row++,M.row>O.end&&(O.start=M.row-O.size+1),H()},moveBackWord(){const e=$.lines[M.row];if(0===M.col)M.row>0&&(M.row--,M.col=$.lines[M.row].length,M.row<O.start&&(O.start=M.row));else{const t=e=>/\s/.test(e),o=e=>/[\p{L}\p{Nd}_]/u.test(e);let n=M.col;if(t(e[n])){for(;n>0&&t(e[n]);)n--;for(;n>0&&o(e[n]);)n--}else if(o(e[n]))for(;n>0&&o(e[n]);)n--;else{const t=e[n--];for(;n>0&&e[n]===t;)n--}M.col=n}H()},moveWord(){const e=$.lines[M.row],t=e.length;if(M.col===t)M.row<$.lastIndex&&(M.col=0,M.row++,M.row>O.end&&(O.start=M.row-O.size+1));else{const o=e=>/\s/.test(e),n=e=>/[\p{L}\p{Nd}_]/u.test(e);let l=M.col;if(o(e[l])){for(;l<t&&o(e[l]);)l++;for(;l<t&&n(e[l]);)l++}else if(n(e[l]))for(;l<t&&n(e[l]);)l++;else{const o=e[l++];for(;l<t&&e[l]===o;)l++}M.col=l}H()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)$.lines[o]=" ".repeat(c.spaces)+$.lines[o];e.col+=c.spaces,t.col+=c.spaces,H()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const n=o===e.row?e:t;let l=0,s=0;const r=$.lines[n.row];let i=n.col;for(;i<r.length&&" "===r.charAt(i);)i++;for(s=i-n.col,i=0;i<n.col&&" "===r.charAt(i);)i++;l=i;const a=Math.min(c.spaces,l+s);$.lines[n.row]=$.lines[n.row].slice(a),s<a&&(n.col-=a-s)}else{const e=$.lines[o];let t=0;for(let o=0;o<Math.min(c.spaces,e.length)&&" "===e.charAt(o);o++)t++;$.lines[o]=e.slice(t)}H()}},I={onContainerRebuild:[],onRenderContent:[],onRenderComplete:[]},$=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=i(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,H()},splice(e,t,o=0){this.lines.splice(e,o,...t),H()},delete(e){this.lines.splice(e,1)}};const O=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,$.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,$.lastIndex),H()},set(e,t){this.start=$clamp(e-1,0,$.lastIndex),this.delta+=t-this.size,this.size=t,H()},get lines(){return $.lines.slice(this.start,this.end+1)}};let _={lineCount:0,row:0,col:0,frameCount:0},A={lineCount:-1,row:-1,col:-1,frameCount:-1};function F(e,t,o){const n=L[e].style;null!=t&&(n.left=t+"ch"),null!=o&&(n.width=o+"ch")}function H(){_.lineCount=$.lastIndex+1,_.row=M.row,_.col=M.col,_.spaces=c.spaces,_.frameCount=A.frameCount+1;for(const[e,t]of a)_[e]!==A[e]&&t(_,r);const e=A;if(A=_,_=e,b){const e=Math.max(w,(O.start+O.displayLines).toString().length);e!==u&&(u=e,b.style.width=g()+"ch",o&&(y.style.width=`calc(${g()+o}ch + ${4*f}px)`))}if(O.delta){if(O.delta>0){const e=L.length;for(let t=0;t<O.delta;t++){x.appendChild(document.createElement("pre")),z.appendChild(document.createElement("div"));const o=L[e+t]=S.appendChild(document.createElement("div"));o.className="buffee-selection",o.style.top=(e+t)*d+"px"}v.appendChild(x),m.appendChild(S),b&&b.appendChild(z)}else if(O.delta<0)for(let e=0;e<-O.delta;e++)b&&b.lastChild?.remove(),v.lastChild?.remove(),L.pop()?.remove();O.delta=0;for(const e of I.onContainerRebuild)e(m,O)}for(let e=0;e<O.displayLines;e++)b&&(b.children[e].textContent=O.start+e+1),v.children[e].textContent=$.lines[O.start+e]??null,L[e].style.width="0ch";for(const e of I.onRenderContent)e(m,O);if(-1===c.interactive)C.style.visibility="hidden";else{const[e,t]=R.ordered,o=e.row-O.start,n=t.row-O.start;for(let o=e.row+1;o<=t.row-1;o++){const e=o-O.start;e>=0&&e<O.size&&F(e,0,$.lines[o].length+1)}if(o>=0&&o<O.size){const n=t.row===e.row?t.col-e.col:$.lines[e.row].length-e.col+1;F(o,e.col,n)}if(t.row!==e.row&&n>=0&&n<O.size){F(n,0,Math.min(t.col,$.lines[t.row].length))}const l=M.row-O.start;if(l>=0&&l<O.size){C.style.top=l*d+"px",C.style.left=M.col+"ch",C.style.visibility="visible";const e=m.getBoundingClientRect(),t=C.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const n=e.left-t.left,l=Math.ceil(n/o);m.scrollLeft-=l*o}else if(t.right>e.right){const n=t.right-e.right,l=Math.ceil(n/o);m.scrollLeft+=l*o}m.scrollLeft=Math.round(m.scrollLeft/o)*o}else C.style.visibility="hidden"}for(const e of I.onRenderComplete)e(m,O);return this}if(this.lineHeight=d,this.Mode=c,this._={get head(){return M},get tail(){return D},get contentOffset(){return{ch:b?g():0,px:b?3*f:f,top:f}},$e:y,$l:m,$textLayer:v,render:H,renderHooks:I,insert:function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return $.lines[e]=$.lines[e].slice(0,t)+o+$.lines[e].slice(t),null;const n=o.split("\n");if(1===n.length)$.lines[e]=$.lines[e].slice(0,t)+o+$.lines[e].slice(t);else{const o=$.lines[e].slice(0,t),l=$.lines[e].slice(t);$.lines[e]=o+n[0];const s=n.slice(1,-1),r=n[n.length-1]+l;$.lines.splice(e+1,0,...s,r)}return n},delete:function(e,t,o){if(0===o.length)return;const n=o.split("\n");if(1===n.length)$.lines[e]=$.lines[e].slice(0,t)+$.lines[e].slice(t+o.length);else{const o=$.lines[e].slice(0,t),l=e+n.length-1,s=n[n.length-1].length,r=$.lines[l].slice(s);$.lines[e]=o+r,$.lines.splice(e+1,n.length-1)}},appendLines(e,t=!1){$.lines.push(...e.map(i)),t||H()}},O.autoFit){const e=()=>{const e=Math.floor(y.clientHeight/d);e>0&&e!==O.size&&(O.delta+=e-O.size,O.size=e,H())};requestAnimationFrame(e),new ResizeObserver(e).observe(y)}else H();m.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&R.insert(t)});const B=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",R.lines.join("\n"))};k.addEventListener("copy",B),k.addEventListener("cut",e=>{B(e),R.delete(),m.focus({preventScroll:!0})});const W={ArrowDown:2,ArrowUp:-2,ArrowLeft:-1,ArrowRight:1};m.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"v"===e.key.toLowerCase())return;if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return k.focus({preventScroll:!0}),void k.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(r.History&&r.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(r.History&&r.History.redo());const t=W[e.key]||0;if(t){const o=t>>31|1;if(e.preventDefault(),-1===c.interactive)return;if(e.metaKey)!e.shiftKey&&R.isSelection&&R.makeCursor(),e.shiftKey&&!R.isSelection&&R.makeSelection(),t%2&&R[o>0?"moveCursorEndOfLine":"moveCursorStartOfLine"]();else if(e.altKey)!e.shiftKey&&R.isSelection&&R.makeCursor(),e.shiftKey&&!R.isSelection&&R.makeSelection(),t%2&&R[o>0?"moveWord":"moveBackWord"]();else if(!e.shiftKey&&R.isSelection)if(t%2)R.setCursor(R.ordered[o>0|0]),H();else{const e=R.ordered[o>0|0],t=$clamp(e.row+o,0,$.lastIndex);t<O.start?O.start=t:t>O.end&&(O.start=t-O.size+1),E=Math.min(e.col,$.lines[t].length),R.setCursor({row:t,col:E}),H()}else e.shiftKey&&!R.isSelection&&R.makeSelection(),R[t%2?"moveCol":"moveRow"](o)}else 1!==c.interactive||("Backspace"===e.key?R.delete():"Enter"===e.key?R.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),e.shiftKey?R.unindent():R.isSelection?R.indent():R.insert(" ".repeat(c.spaces))):e.key.length>1?l.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),R.insert(e.key))))})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}