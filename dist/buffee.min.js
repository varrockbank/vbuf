function Buffee(e,{rows:t,cols:o,spaces:s=4}={}){this.version="12.6.6-alpha.1";const l=this,r=e=>f.spaces?e.replace(/\t/g," ".repeat(f.spaces)):e,n=e=>/\s/.test(e),i=e=>/[\p{L}\p{Nd}_]/u.test(e),c=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),a=t=>e.querySelector(t),h=(e,t,o)=>e<t?t:e>o?o:e,f={spaces:s,interactive:1};let w=-1;const d=c("--buffee-cell"),u=c("--buffee-padding"),g=c("--buffee-gutter-digits-initial"),p=()=>w+c("--buffee-gutter-digits-padding"),y=a(".buffee-elements"),m=a(".buffee-lines"),v=a(".buffee-cursor"),C=a(".buffee-layer-text"),L=a(".buffee-layer-selection"),k=a(".buffee-clipboard-bridge"),S=a(".buffee-gutter"),x=[[[],document.createDocumentFragment(),C,"pre",(e,t)=>e.textContent=M.lines[F.start+t]??null],[[],document.createDocumentFragment(),S,"div",(e,t)=>e.textContent=F.start+t+1],[[],document.createDocumentFragment(),L,"div",e=>e.style.width=0]];o&&!S&&(y.style.width=`calc(${o}ch + ${2*u}px)`),t&&x.forEach(([,,e])=>e&&(e.style.height=t*d+"px"));const b={row:0,col:0};let z={row:0,col:0},K=z,_=z.col;const D=this.Selection={get ordered(){return this.isForwardSelection?[K,z]:[z,K]},moveRow(e){e>0?z.row<M.lastIndex&&(z.col=Math.min(_,M.lines[++z.row].length),z.row>F.end&&(F.start=z.row-F.size+1)):z.row>0&&(z.col=Math.min(_,M.lines[--z.row].length),z.row<F.start&&(F.start=z.row)),H()},moveCol(e){1===e?z.col<M.lines[z.row].length?_=++z.col:z.row<M.lastIndex&&(_=z.col=0,++z.row>F.end&&(F.start=z.row-F.size+1)):z.col>0?_=--z.col:z.row>0&&(_=z.col=M.lines[--z.row].length,z.row<F.start&&(F.start=z.row)),H()},get isSelection(){return z!==K},get isForwardSelection(){return K.row===z.row&&K.col<z.col||K.row<z.row},setCursor({row:e,col:t}){z.row=e,z.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=M.lines[e.row],s=[o.slice(e.col,t.col)];return t.col>=o.length&&e.row<M.lastIndex&&s.push(""),s}{const o=M.lines[e.row].slice(e.col),s=M.lines[t.row].slice(0,t.col);return[o,...M.lines.slice(e.row+1,t.row),s]}},makeCursor(){K.row=z.row,K.col=z.col,z=K},makeSelection(){z=b,z.row=K.row,z.col=K.col},moveCursorStartOfLine(){var e;_=z.col=(e=M.lines[z.row].search(/[^ ]/))>0&&e<K.col?e:0,H()},moveCursorEndOfLine(){_=z.col=M.lines[z.row].length,H()},insert(e,t=!1){if(e=r(e),this.isSelection){const[t]=this.ordered,o=this.lines.join("\n");l._._delete(t.row,t.col,o);const s=l._._insert(t.row,t.col,e);z.row=t.row,s?.length>1?(z.row+=s.length-1,z.col=s[s.length-1].length):z.col=t.col+e.length,this.makeCursor()}else{const t=l._._insert(K.row,K.col,e);t?.length>1?(z.row+=t.length-1,_=z.col=t[t.length-1].length):_=z.col+=e.length}t||H()},delete(){if(this.isSelection)return this.insert("");if(K.col>0){const e=M.lines[K.row][K.col-1];l._._delete(K.row,K.col-1,e),z.col--}else if(K.row>0){const e=M.lines[K.row-1].length;l._._delete(K.row-1,e,"\n"),z.col=e,--z.row<F.start&&(F.start=z.row)}H()},newLine(){this.isSelection&&D.insert("",!0),l._._insert(K.row,K.col,"\n"),z.col=0,z.row++,z.row>F.end&&(F.start=z.row-F.size+1),H()},moveBackWord(){if(0===z.col)z.row>0&&(z.col=M.lines[--z.row].length,z.row<F.start&&(F.start=z.row));else{const e=M.lines[z.row];let t=z.col;if(n(e[t])){for(;t>0&&n(e[t]);)t--;for(;t>0&&i(e[t]);)t--}else if(i(e[t]))for(;t>0&&i(e[t]);)t--;else{const o=e[t--];for(;t>0&&e[t]===o;)t--}z.col=t}H()},moveWord(){const e=M.lines[z.row],t=e.length;if(z.col===t)z.row<M.lastIndex&&(z.col=0,++z.row>F.end&&(F.start=z.row-F.size+1));else{let o=z.col;if(n(e[o])){for(;o<t&&n(e[o]);)o++;for(;o<t&&i(e[o]);)o++}else if(i(e[o]))for(;o<t&&i(e[o]);)o++;else{const s=e[o++];for(;o<t&&e[o]===s;)o++}z.col=o}H()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)M.lines[o]=" ".repeat(f.spaces)+M.lines[o];e.col+=f.spaces,t.col+=f.spaces,H()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const s=o===e.row?e:t;let l=0,r=0;const n=M.lines[s.row];let i=s.col;for(;i<n.length&&" "===n.charAt(i);)i++;for(r=i-s.col,i=0;i<s.col&&" "===n.charAt(i);)i++;l=i;const c=Math.min(f.spaces,l+r);M.lines[s.row]=M.lines[s.row].slice(c),r<c&&(s.col-=c-r)}else{const e=M.lines[o];let t=0;for(;t<f.spaces&&" "===e[t];)t++;M.lines[o]=e.slice(t)}H()}},E=[],M=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=r(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,H()},splice(e,t,o=0){this.lines.splice(e,o,...t),H()},delete(e){this.lines.splice(e,1)}};const F=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,M.lastIndex)},scroll(e){this.start=h(this.start+e,0,M.lastIndex),H()},set(e,t){this.start=h(e-1,0,M.lastIndex),this.delta+=t-this.size,this.size=t,H()},get lines(){return M.lines.slice(this.start,this.end+1)}};let I=0;function A(e,t,o){const s=x[2][0][e].style;s.left=t+"ch",s.width=o+"ch"}function H(){if(I++,S){const e=Math.max(g,(F.start+F.displayLines).toString().length);e!==w&&(w=e,S.style.width=p()+"ch",o&&(y.style.width=`calc(${p()+o}ch + ${4*u}px)`))}const e=F.delta;if(e){if(e>0){for(let t=0;t<e;t++)x.forEach(([e,t,,o])=>e.push(t.appendChild(document.createElement(o))));x.forEach(([,e,t])=>t?.appendChild(e))}else for(let t=0;t<-e;t++)x.forEach(([e])=>e.pop()?.remove());F.delta=0}for(let e=0;e<F.displayLines;e++)x.forEach(([t,,,,o])=>t[e]&&o(t[e],e));if(f.interactive<0)v.style.left="-1ch";else{const[e,t]=D.ordered,o=e.row-F.start,s=t.row-F.start;for(let o=e.row+1;o<=t.row-1;o++){const e=o-F.start;e>=0&&e<F.size&&A(e,0,M.lines[o].length+1)}if(o>=0&&o<F.size){const s=t.row===e.row?t.col-e.col:M.lines[e.row].length-e.col+1;A(o,e.col,s)}t.row!==e.row&&s>=0&&s<F.size&&A(s,0,Math.min(t.col,M.lines[t.row].length));const l=z.row-F.start;if(l>=0&&l<F.size){v.style.top=l*d+"px",v.style.left=z.col+"ch";const e=m.getBoundingClientRect(),t=v.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const s=e.left-t.left,l=Math.ceil(s/o);m.scrollLeft-=l*o}else if(t.right>e.right){const s=t.right-e.right,l=Math.ceil(s/o);m.scrollLeft+=l*o}m.scrollLeft=Math.round(m.scrollLeft/o)*o}}for(const t of E)t(m,F,e)}if(this.lineHeight=d,this.Mode=f,this._={get head(){return z},get tail(){return K},get frameCount(){return I},get contentOffset(){return{ch:S?p():0,px:S?3*u:u,top:u}},$e:y,$l:m,$textLayer:C,render:H,renderHooks:E,_insert:function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return M.lines[e]=M.lines[e].slice(0,t)+o+M.lines[e].slice(t),null;const s=o.split("\n");if(1===s.length)M.lines[e]=M.lines[e].slice(0,t)+o+M.lines[e].slice(t);else{const o=M.lines[e].slice(0,t),l=M.lines[e].slice(t);M.lines[e]=o+s[0];const r=s.slice(1,-1),n=s[s.length-1]+l;M.lines.splice(e+1,0,...r,n)}return s},_delete:function(e,t,o){if(0===o.length)return;const s=o.split("\n");if(1===s.length)M.lines[e]=M.lines[e].slice(0,t)+M.lines[e].slice(t+o.length);else{const o=M.lines[e].slice(0,t),l=e+s.length-1,r=s[s.length-1].length,n=M.lines[l].slice(r);M.lines[e]=o+n,M.lines.splice(e+1,s.length-1)}},appendLines(e,t=!1){M.lines.push(...e.map(r)),t||H()}},F.autoFit){const e=()=>{const e=Math.floor(y.clientHeight/d);e>0&&e!==F.size&&(F.delta+=e-F.size,F.size=e,H())};requestAnimationFrame(e),new ResizeObserver(e).observe(y)}else H();m.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&D.insert(t)});const $=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",D.lines.join("\n"))};k.addEventListener("copy",$),k.addEventListener("cut",e=>{$(e),D.delete(),m.focus({preventScroll:!0})});const B={ArrowDown:2,ArrowUp:-2,ArrowLeft:-1,ArrowRight:1};m.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"v"===e.key.toLowerCase())return;if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return k.focus({preventScroll:!0}),void k.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(l.History&&l.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(l.History&&l.History.redo());const t=B[e.key]||0;if(t){const o=t>>31|1;if(e.preventDefault(),-1===f.interactive)return;if(e.metaKey)!e.shiftKey&&D.isSelection&&D.makeCursor(),e.shiftKey&&!D.isSelection&&D.makeSelection(),t%2&&D[o>0?"moveCursorEndOfLine":"moveCursorStartOfLine"]();else if(e.altKey)!e.shiftKey&&D.isSelection&&D.makeCursor(),e.shiftKey&&!D.isSelection&&D.makeSelection(),t%2&&D[o>0?"moveWord":"moveBackWord"]();else if(!e.shiftKey&&D.isSelection)if(t%2)D.setCursor(D.ordered[o>0|0]),H();else{const e=D.ordered[o>0|0],t=h(e.row+o,0,M.lastIndex);t<F.start?F.start=t:t>F.end&&(F.start=t-F.size+1),_=Math.min(e.col,M.lines[t].length),D.setCursor({row:t,col:_}),H()}else e.shiftKey&&!D.isSelection&&D.makeSelection(),D[t%2?"moveCol":"moveRow"](o)}else 1!==f.interactive||"Escape"===e.key||("Backspace"===e.key?D.delete():"Enter"===e.key?D.newLine():"Tab"===e.key?(e.preventDefault(),e.shiftKey?D.unindent():D.isSelection?D.indent():D.insert(" ".repeat(f.spaces))):1==e.key.length&&(" "===e.key&&e.preventDefault(),D.insert(e.key)))})}