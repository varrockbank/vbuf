<html>
<head>
<title>Buffee, the text slayer</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="reset.css">
<link rel="stylesheet" href="style.css">
<script src="buffee.js"></script>
<script src="extensions/tui-legacy.js"></script>
<style>
  /* Colors - define per instance */
  .wb {
    background-color: #282C34;
    color: #B2B2B2;
    border: 1px solid black;
  }
  .wb .wb-selection {
    background-color: #EDAD10;
  }
  .wb .wb-cursor {
    background-color: #FF6B6B;
  }

  /* Syntax highlighting colors */
  .wb .wb-lines pre .highlight-function {
    color: orange;
  }
  .wb .wb-lines pre .highlight-function-name {
    color: cadetblue;
  }
  .wb .wb-lines pre .highlight-string {
    color: green;
  }

  /* HackerNews instance colors */
  #hackernews.wb {
    background-color: #F6F6EF;
    color: black;
  }
  #hackernews.wb .wb-selection {
    background-color: #DCDCDA;
  }

  /* Playground instance colors */
  #playground.wb {
    background-color: #201430;
    color: #E1D6F8;
  }
  #playground.wb .wb-selection {
    background-color: #F9AD40;
  }

  /* TUI demo instance colors */
  #tui-demo.wb {
    background-color: #1a1a2e;
    color: #eaeaea;
  }
  #tui-demo.wb .wb-selection {
    background-color: #9d4edd;
  }
</style>
</head>

<body>
  <nav id="nav"></nav>
  <script>
    fetch('navigation.html')
      .then(r => r.text())
      .then(html => document.getElementById('nav').innerHTML = html);
  </script>
  <p><strong>buffee, the text slayer</strong> (<span id="vbuf-version"></span>) â€” an embeddable text editor for the web â€” compact, fast, unleashed</p>

  <!-- Features Section -->
  <div style="padding: 12px 0;">
    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 32px;">
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0.01MB</h3>
        <p style="margin: 0; font-size: 14px;"><a href="dist/buffee.min.js">distributable</a> (gz+min)</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0</h3>
        <p style="margin: 0; font-size: 14px;">Dependencies</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0ms</h3>
        <p style="margin: 0; font-size: 14px;">Build time</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0ms</h3>
        <p style="margin: 0; font-size: 14px;">VDOM overhead</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">~70m</h3>
        <p style="margin: 0; font-size: 14px;">LOC capacity</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">1B+</h3>
        <p style="margin: 0; font-size: 14px;">in <a href="samples/ultra-high-capacity.html">pro max mode</a></p>
      </div>
    </div>
  </div>

    <!-- Main Playground -->
    <section>
      <blockquote cite="" class="ğŸ’ª ğŸœ ğŸ¥· ğŸŒ• ğŸªœ wb no-select" tabindex="0" id="playground">
        <!-- Hidden clipboard bridge lives inside the editor so copy bubbles through it -->
        <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
          <div class="ğŸ’ª wb-content">
              <div class="wb-gutter"></div>
              <div class="wb-lines ğŸŒ³ ğŸ¥·"></div>
          </div>
          <div class="ğŸ’ª wb-status ğŸ¦ ">
              <div class="wb-status-left ğŸ’ª">
                  <span class="wb-linecount"></span>
              </div>
              <div class="wb-status-right ğŸ’ª">
                  <span class="wb-coordinate"></span>
                  <span>|</span>
                  <span class="wb-indentation"></span>
              </div>
          </div>
      </blockquote>
    </section>

    <!-- About -->
    <section>
      <h3>Text slayer, editor, UI</h3>
      <p>Essentially this a rendering engine for fixed-width cells in grid-layout.
        The grid as viewport into an arbitrarily large buffer of text lines.
      </p>
      <p>The core implementation tightly couples rendering and editing capabilities.
        The original prototype served to view large distributed server logs. 
        It turns out that making performance headway in this area translates to being a performant text editor.
        The key optimization is sidestepping DOM bottlenecks and avoiding JavaScript fatigue. 
      </p>
      <p>
        TUI capabilities ship as an extension. The goal is to liberate OrgMode from the Emacs text-based UI, err operating system. 
        The advent of AI coding has also ignited interest in TUIs, particularly 
        terminal-based agentic prompts. Buffee completes the circle:
        where <a href="https://github.com/dankamongmen/notcurses">notcurses</a> brings browser bling to the terminal, buffee brings 20th century drab 
        to the modern web.  
      </p>
      </p>
      <p>
        We'd like to thank the wizards of V8. Compactness is possible because V8 arrays proved instaneously fast. Compare with complex 
        structures, plural, needed by native editors, e.g. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">piecetable</a>. 
        Content/syntax-aware considerations aside, buffee rivals or outperforms titans of the text editor industry. 
      </p>
    </section>

    <!-- TUI Mode Demo -->
    <section>
      <h3>TUI Mode</h3>
      <p>Terminal UI mode placing interactive elements in the buffer. <kbd>Tab</kbd> to next element. <kbd>Enter</kbd> to activate.</p>

      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
        <button id="tui-toggle-btn">Enable TUI Mode</button>
        <button id="tui-highlight-toggle-btn" class="hidden">Highlight All</button>
      </div>
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
        <label>Row:</label>
        <input type="number" id="tui-row" value="0" style="width: 60px;">
        <label>Col:</label>
        <input type="number" id="tui-col" value="0" style="width: 60px;">
        <label>Content:</label>
        <input type="text" id="tui-content" value="Foobar" style="width: 120px;">
        <button id="tui-add-btn">Add Element</button>
      </div>
      <blockquote cite="" class="ğŸ’ª ğŸœ ğŸ¥· ğŸŒ• ğŸªœ wb no-select" tabindex="0" id="tui-demo">
        <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
        <div class="ğŸ’ª wb-content">
          <div class="wb-gutter"></div>
          <div class="wb-lines ğŸŒ³ ğŸ¥·"></div>
        </div>
        <div class="ğŸ’ª wb-status ğŸ¦ ">
          <div class="wb-status-left ğŸ’ª">
            <span class="wb-linecount"></span>
          </div>
          <div class="wb-status-right ğŸ’ª">
            <span class="wb-coordinate"></span>
            <span>|</span>
            <span class="wb-indentation"></span>
          </div>
        </div>
      </blockquote>
    </section>

    <!-- Dynamic Data Demo -->
    <section>
      <h3>HackerNews Front Page</h3>
      <p>Example of loading data from APIs.</p>
    <blockquote cite="" class="ğŸ’ª ğŸœ ğŸ¥· ğŸŒ• ğŸªœ wb no-select" tabindex="0" id="hackernews">
      <!-- Hidden clipboard bridge lives inside the editor so copy bubbles through it -->
      <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
      <div class="ğŸ’ª wb-content">
        <div class="wb-gutter"></div>
        <div class="wb-lines ğŸŒ³ ğŸ¥·"></div>
      </div>
      <div class="ğŸ’ª wb-status ğŸ¦ ">
        <div class="wb-status-left ğŸ’ª">
          <span class="wb-linecount"></span>
        </div>
        <div class="wb-status-right ğŸ’ª">
          <span class="wb-coordinate"></span>
          <span>|</span>
          <span class="wb-indentation"></span>
        </div>
      </div>
    </blockquote>
    </section>
  </div> <!-- End container -->

  <script type="module">
    import { Parser, Language, Query } from "https://cdn.jsdelivr.net/npm/web-tree-sitter@0.25.10/tree-sitter.js";

    await Parser.init(); // loads tree-sitter.wasm from the same CDN path
    const treesitterParser = new Parser();
    const javascriptParser = await Language.load(
      "https://cdn.jsdelivr.net/npm/tree-sitter-wasms@0.1.12/out/tree-sitter-javascript.wasm"
    );
    treesitterParser.setLanguage(javascriptParser);
    const highlightQuery = `
      (function_declaration name: (identifier) @function)
      (string) @string
    `;
    const query = new Query(javascriptParser, highlightQuery);
    
    window.treesitterInstance = {
       query,
       parser: treesitterParser 
    };

</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const mainElement = document.getElementById("playground");
    const primary = new Buffee(mainElement, {
      viewportRows: 20,
      colorPrimary: "#87FF5F",
      colorSecondary: "#38274D"
    });
    mainElement.focus();
    window.primary = primary;

    // Set version from vbuf instance
    document.getElementById('vbuf-version').textContent = 'v' + primary.version;

    const hackerNewsElement = document.getElementById('hackernews');
    const hackernews = new Buffee(hackerNewsElement, {
      viewportRows: 20,
      colorPrimary: "black",
      colorSecondary: "#FF6602",
      showStatusLine: false,
    });

    fetch("docs/instructions.txt")
      .then(response => response.text())
      .then(source => primary.Model.text = source)
      .catch(err => console.error("Error reading instructions.txt:", err));

    // Fetch Hacker News as plaintext
    async function fetchHackerNewsText() {
      const response = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json');
      const storyIds = await response.json();

      // Get top 30 stories
      const stories = await Promise.all(
        storyIds.slice(0, 30).map(async (id) => {
          const storyRes = await fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`);
          return storyRes.json();
        })
      );

      // Format as plaintext
      const plaintext = stories
        .map((story, i) => {
          const title = story.title || 'No title';
          const url = story.url || `https://news.ycombinator.com/item?id=${story.id}`;
          const points = story.score || 0;
          const comments = story.descendants || 0;
          return `${i + 1}. ${title}\n   ${url}\n   ${points} points | ${comments} comments\n`;
        })
        .join('\n');

      return plaintext;
    }

    fetchHackerNewsText()
      .then(text => hackernews.Model.text = text)
      .catch(err => console.error("Error fetching Hacker News:", err));

    // TUI Mode Demo
    const tuiDemoElement = document.getElementById('tui-demo');
    const tuiDemo = new Buffee(tuiDemoElement, {
      colorPrimary: "#eaeaea",
      colorSecondary: "#16213e",
      viewportRows: 15,
    });
    BuffeeTUI(tuiDemo);  // Initialize TUI extension

const fileTemplate = `
                â•‘
â”€â”¤â–‘â–‘â–‘â–‘Filesâ–‘â–‘â–‘â”œâ”€â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£       
                â•‘
                â•‘              
                â•‘                   
                â•‘              
                â•‘        
                â•‘
                â•‘                    
                â•‘
`;
    // File contents
    const files = {
      'main.js': [
        'function main() {',
        '  console.log("Hello");',
        '  init();',
        '}',
        '',
        'main();'
      ],
      'styles.css': [
        'body {',
        '  margin: 0;',
        '  font-family: sans;',
        '}',
        '.btn { color: blue; }'
      ],
      'config.json': [
        '{',
        '  "name": "myapp",',
        '  "version": "1.0",',
        '  "port": 3000',
        '}'
      ],
      'README.md': [
        '# My Project',
        '',
        'A demo application.',
        '',
        '## Install',
        'npm install'
      ],
      'index.html': [
        '<!DOCTYPE html>',
        '<html>',
        '<head>',
        '  <title>App</title>',
        '</head>',
        '<body></body>',
        '</html>'
      ],
      'data.csv': [
        'name,age,city',
        'Alice,30,NYC',
        'Bob,25,LA',
        'Carol,35,Chicago'
      ],
      '.env': [
        'API_KEY=sk-xxx',
        'DEBUG=true',
        'PORT=8080'
      ],
      'notes.txt': [
        'TODO:',
        '- Fix bug #42',
        '- Add tests',
        '- Update docs'
      ]
    };

    // Track element IDs for each file
    const fileElementIds = {};

    // Function to load file content
    function loadFile(name) {
      // Update buttons: remove and re-add with updated content
      const fileNames = Object.keys(files);
      fileNames.forEach((fname, i) => {
        if (fileElementIds[fname]) {
          tuiDemo.TUI.removeElement(fileElementIds[fname]);
        }
        const label = fname === name ? '> ' + fname : '  ' + fname;
        fileElementIds[fname] = tuiDemo.TUI.addButton({
          row: i + 3,
          col: 2,
          label,
          onActivate: () => loadFile(fname)
        });
      });

      const lines = tuiDemo.Model.lines;
      const content = files[name] || [];
      for (let i = 0; i < lines.length; i++) {
        // Skip rows 1-2 (header/separator rows)
        if (i === 1 || i === 2) continue;

        // Find the divider position dynamically
        const dividerPos = lines[i].search(/[â•‘â• â•£]/);
        if (dividerPos === -1) continue;

        let right;
        if (i === 0) {
          // Show filename in header - preserve the 16 spaces before â•‘
          lines[i] = '                â•‘' + ' ' + name;
          continue;
        }
        const left = lines[i].slice(0, dividerPos + 1); // Keep left side + divider
        if (i >= 3) {
          // Content starts at row 3
          right = ' ' + (content[i - 3] || '');
        }
        lines[i] = left + right;
      }
      // Trigger re-render
      tuiDemo.TUI.enabled = true;
    }

    // Initialize with template
    tuiDemo.Model.text = fileTemplate.trim();

    // Show initial file (also creates the file list elements)
    loadFile('main.js');

    // Add a prompt at the bottom
    tuiDemo.TUI.addPrompt({
      row: 12,
      col: 18,
      width: 40,
      title: 'Command',
      onActivate: (el) => alert('Command: ' + el.input)
    });

    // Enable TUI mode by default
    tuiDemo.TUI.enabled = true;
    document.getElementById('tui-toggle-btn').textContent = 'Disable TUI Mode';

    const tuiHighlightBtn = document.getElementById('tui-highlight-toggle-btn');
    tuiHighlightBtn.classList.remove('hidden');
    tuiHighlightBtn.textContent = 'Unhighlight All';
    let tuiHighlighted = true;

    document.getElementById('tui-toggle-btn').addEventListener('click', () => {
      tuiDemo.TUI.enabled = !tuiDemo.TUI.enabled;
      document.getElementById('tui-toggle-btn').textContent = tuiDemo.TUI.enabled ? 'Disable TUI Mode' : 'Enable TUI Mode';
      tuiHighlightBtn.classList.toggle('hidden', !tuiDemo.TUI.enabled);
    });

    tuiHighlightBtn.addEventListener('click', () => {
      tuiHighlighted = !tuiHighlighted;
      tuiDemo.TUI.setHighlight(tuiHighlighted);
      tuiHighlightBtn.textContent = tuiHighlighted ? 'Unhighlight All' : 'Highlight All';
    });

    document.getElementById('tui-add-btn').addEventListener('click', () => {
      const row = parseInt(document.getElementById('tui-row').value) || 0;
      const col = parseInt(document.getElementById('tui-col').value) || 0;
      const label = document.getElementById('tui-content').value || 'Button';
      tuiDemo.TUI.addButton({ row, col, label });
    });

    // Bind Tab to nextElement, other keys to handleKeyDown in TUI mode
    tuiDemoElement.addEventListener('keydown', (e) => {
      if (!tuiDemo.TUI.enabled) return;
      if (e.key === 'Tab') {
        e.preventDefault();
        tuiDemo.TUI.nextElement();
      } else {
        e.preventDefault();
        tuiDemo.TUI.handleKeyDown(e.key);
      }
    });

    // Expose for debugging
    window.tuiDemo = tuiDemo;
  });
</script>
</body>
</html>
