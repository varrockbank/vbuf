<html>
<head>
<title>Buffee, the text slayer</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="assets/reset.css">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="themes/theme-eva.css">
<link rel="stylesheet" href="themes/theme-hn.css">
<link rel="stylesheet" href="themes/theme-kai.css">
<script src="buffee.js"></script>
<script src="extensions/statusline.js"></script>
<script src="extensions/highlights.js"></script>
<script src="extensions/tui.js"></script>
<style>
  .point {
    display: grid; grid-template-columns: repeat(6, 1fr); gap: 32px;
    padding: 12px 0;
  }
  .point > div > h3 {
    font-size: 32px; margin: 0 0 8px 0; font-weight: 700;
  }
  .point > div > p {
    margin: 0; font-size: 14px;
  }
</style>
</head>

<body>
  <nav id="nav"></nav>
  <script>
    fetch('web/navigation.html')
      .then(r => r.text())
      .then(html => document.getElementById('nav').innerHTML = html);
  </script>
  <p><strong>Buffee, the text slayer</strong> <span id="buffee-version"></span> — embeddable terminal-style text editor for netizens — compact, fast, unbounded</p>

  <div class="point">
    <div>
      <h3>0.01MB</h3>
      <p><a href="dist/Buffee.min.js">distributable</a> (gz+min)</p>
    </div>
    <div>
      <h3>0</h3>
      <p>Dependencies</p>
    </div>
    <div>
      <h3>0ms</h3>
      <p>Build time</p>
    </div>
    <div>
      <h3>0ms</h3>
      <p>VDOM overhead</p>
    </div>
    <div>
      <h3>~70m</h3>
      <p>LOC capacity</p>
    </div>
    <div>
      <h3>1B+</h3>
      <p>in <a href="samples/ultra-high-capacity.html">pro max mode</a></p>
    </div>
  </div>

    <!-- Main Playground -->
    <section>
      <div class="buffee buffee-themepack1-eva" id="playground">
        <textarea class="buffee-clipboard-bridge" aria-hidden="true"></textarea>
        <div class="no-select buffee-elements">
          <div class="buffee-gutter"></div>
          <div class="buffee-lines" tabindex="0">
            <blockquote class="buffee-layer-text"></blockquote>
            <div class="buffee-layer-elements"></div>
            <div class="buffee-cursor"></div>
          </div>
        </div>
        <div class="buffee-status">
          <div class="buffee-status-left"><span class="buffee-linecount"></span></div>
          <div class="buffee-status-right">
            Ln <span class="buffee-head-row"></span>, Col <span class="buffee-head-col"></span>
            <span class="buffee-status-divider">|</span>
            <span class="buffee-spaces"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- About -->
    <section>
      <h3>Inspired by the terminal</h3>
      <p>
        This microlibrary is inspired by the spartan performance and minimalism of terminal interfaces and Vim.
      </p>
      <p>Buffee is efficient as a rendering engine for monospace plaintext in grid-layout.
        The grid being viewport into an arbitrarily large buffer of text lines.
      </p>
      <p>To maximize performance, the core implementation tighly couples text editing operations with rendering.
        The project originated as a way to inspect massive, distributed server log files directly in the browser.
        Breakthroughs in this problem space were distilled down to Buffee. 
        The key optimization is sidestepping DOM bottlenecks and avoiding JavaScript fatigue. 
      </p>
      <p>
        TUI capabilities ship as an extension. One day we will liberate OrgMode from the text-based-UI, err operating system, that is Emacs. 
        Terminal-based agentic coding tools have also ignited interest in TUIs. 
        Where <a href="https://github.com/dankamongmen/notcurses">notcurses</a> brings browser bling to the terminal, Buffee completes the circle 
        by ushering in 20th century paradigms to the modern web.  
      </p>
      </p>
      <p>
        Much is owed to the wizards of V8. Compactness was made possible because V8 arrays proved instaneously fast. Compare with complex 
        structures, plural, needed by native editors, e.g. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">piecetable</a>. 
        Content/syntax-aware considerations aside, Buffee rivals titans of the text editor industry. 
      </p>
    </section>

    <!-- TUI Mode Demo -->
    <section>
      <h3>TUI Mode</h3>
      <p>Terminal UI mode placing interactive elements in the buffer. <kbd>Tab</kbd> to next element. <kbd>Enter</kbd> to activate.</p>

      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
        <button id="tui-toggle-btn">Enable TUI Mode</button>
        <button id="tui-highlight-toggle-btn" class="hidden">Highlight All</button>
      </div>
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
        <label>Row:</label>
        <input type="number" id="tui-row" value="0" style="width: 60px;">
        <label>Col:</label>
        <input type="number" id="tui-col" value="0" style="width: 60px;">
        <label>Content:</label>
        <input type="text" id="tui-content" value="Foobar" style="width: 120px;">
        <button id="tui-add-btn">Add Element</button>
      </div>
      <div class="buffee buffee-themepack1-kai" id="tui-demo">
        <textarea class="buffee-clipboard-bridge" aria-hidden="true"></textarea>
        <div class="no-select buffee-elements">
          <div class="buffee-gutter"></div>
          <div class="buffee-lines" tabindex="0">
            <blockquote class="buffee-layer-text"></blockquote>
            <div class="buffee-layer-elements"></div>
            <div class="buffee-cursor"></div>
          </div>
        </div>
        <div class="buffee-status">
          <div class="buffee-status-left"><span class="buffee-linecount"></span></div>
          <div class="buffee-status-right">
            Ln <span class="buffee-head-row"></span>, Col <span class="buffee-head-col"></span>
            <span class="buffee-status-divider">|</span>
            <span class="buffee-spaces"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Dynamic Data Demo -->
    <section>
      <h3>HackerNews Front Page</h3>
      <p>Example of loading data from APIs.</p>
    <div class="buffee buffee-themepack1-hn" id="hackernews">
      <textarea class="buffee-clipboard-bridge" aria-hidden="true"></textarea>
      <div class="no-select buffee-elements">
        <div class="buffee-gutter"></div>
        <div class="buffee-lines" tabindex="0">
          <blockquote class="buffee-layer-text"></blockquote>
          <div class="buffee-layer-elements"></div>
          <div class="buffee-cursor"></div>
        </div>
      </div>
    </div>
    </section>
  </div> <!-- End container -->

  <script type="module">
    import { Parser, Language, Query } from "https://cdn.jsdelivr.net/npm/web-tree-sitter@0.25.10/tree-sitter.js";

    await Parser.init(); // loads tree-sitter.wasm from the same CDN path
    const treesitterParser = new Parser();
    const javascriptParser = await Language.load(
      "https://cdn.jsdelivr.net/npm/tree-sitter-wasms@0.1.12/out/tree-sitter-javascript.wasm"
    );
    treesitterParser.setLanguage(javascriptParser);
    const highlightQuery = `
      (function_declaration name: (identifier) @function)
      (string) @string
    `;
    const query = new Query(javascriptParser, highlightQuery);
    
    window.treesitterInstance = {
       query,
       parser: treesitterParser 
    };

</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const mainElement = document.getElementById("playground");
    const primary = new Buffee(mainElement, {
      rows: 20,
      callbacks: BuffeeStatusLine(mainElement)
    });
    mainElement.querySelector('.buffee-lines').focus();
    window.primary = primary;

    // Set version from Buffee instance
    document.getElementById('buffee-version').textContent = '( v' + primary.version + ' )';

    const hackerNewsElement = document.getElementById('hackernews');
    const hackernews = new Buffee(hackerNewsElement, {
      rows: 20,
      callbacks: BuffeeStatusLine(hackerNewsElement)
    });

    fetch("assets/instructions.txt")
      .then(response => response.text())
      .then(source => primary.Model.text = source)
      .catch(err => console.error("Error reading instructions.txt:", err));

    // Fetch Hacker News as plaintext
    async function fetchHackerNewsText() {
      const response = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json');
      const storyIds = await response.json();

      // Get top 30 stories
      const stories = await Promise.all(
        storyIds.slice(0, 30).map(async (id) => {
          const storyRes = await fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`);
          return storyRes.json();
        })
      );

      // Format as plaintext
      const plaintext = stories
        .map((story, i) => {
          const title = story.title || 'No title';
          const url = story.url || `https://news.ycombinator.com/item?id=${story.id}`;
          const points = story.score || 0;
          const comments = story.descendants || 0;
          return `${i + 1}. ${title}\n   ${url}\n   ${points} points | ${comments} comments\n`;
        })
        .join('\n');

      return plaintext;
    }

    fetchHackerNewsText()
      .then(text => hackernews.Model.text = text)
      .catch(err => console.error("Error fetching Hacker News:", err));

    // TUI Mode Demo
    const tuiDemoElement = document.getElementById('tui-demo');
    const tuiDemo = new Buffee(tuiDemoElement, {
      rows: 15,
      callbacks: BuffeeStatusLine(tuiDemoElement)
    });
    BuffeeTUI(tuiDemo);  // Initialize TUI extension

const fileTemplate = `
                ║
─┤░░░░Files░░░├─╠══════════════════════════════════════════════════
════════════════╣       
                ║
                ║              
                ║                   
                ║              
                ║        
                ║
                ║                    
                ║
`;
    // File contents
    const files = {
      'main.js': [
        'function main() {',
        '  console.log("Hello");',
        '  init();',
        '}',
        '',
        'main();'
      ],
      'styles.css': [
        'body {',
        '  margin: 0;',
        '  font-family: sans;',
        '}',
        '.btn { color: blue; }'
      ],
      'config.json': [
        '{',
        '  "name": "myapp",',
        '  "version": "1.0",',
        '  "port": 3000',
        '}'
      ],
      'README.md': [
        '# My Project',
        '',
        'A demo application.',
        '',
        '## Install',
        'npm install'
      ],
      'index.html': [
        '<!DOCTYPE html>',
        '<html>',
        '<head>',
        '  <title>App</title>',
        '</head>',
        '<body></body>',
        '</html>'
      ],
      'data.csv': [
        'name,age,city',
        'Alice,30,NYC',
        'Bob,25,LA',
        'Carol,35,Chicago'
      ],
      '.env': [
        'API_KEY=sk-xxx',
        'DEBUG=true',
        'PORT=8080'
      ],
      'notes.txt': [
        'TODO:',
        '- Fix bug #42',
        '- Add tests',
        '- Update docs'
      ]
    };

    // Track element IDs for each file
    const fileElementIds = {};

    // Function to load file content
    function loadFile(name) {
      // Update buttons: remove and re-add with updated content
      const fileNames = Object.keys(files);
      fileNames.forEach((fname, i) => {
        if (fileElementIds[fname]) {
          tuiDemo.TUI.removeElement(fileElementIds[fname]);
        }
        const label = fname === name ? '> ' + fname : '  ' + fname;
        fileElementIds[fname] = tuiDemo.TUI.addButton({
          row: i + 3,
          col: 2,
          label,
          onActivate: () => loadFile(fname)
        });
      });

      // Focus the selected file's button (files are at indices 0-4 in sorted order)
      const fileIndex = fileNames.indexOf(name);
      if (fileIndex !== -1) tuiDemo.TUI.setCurrentIndex(fileIndex);

      const lines = tuiDemo.Model.lines;
      const content = files[name] || [];
      for (let i = 0; i < lines.length; i++) {
        // Skip rows 1-2 (header/separator rows)
        if (i === 1 || i === 2) continue;

        // Find the divider position dynamically
        const dividerPos = lines[i].search(/[║╠╣]/);
        if (dividerPos === -1) continue;

        let right;
        if (i === 0) {
          // Show filename in header - preserve the 16 spaces before ║
          lines[i] = '                ║' + ' ' + name;
          continue;
        }
        const left = lines[i].slice(0, dividerPos + 1); // Keep left side + divider
        if (i >= 3) {
          // Content starts at row 3
          right = ' ' + (content[i - 3] || '');
        }
        lines[i] = left + right;
      }
      // Trigger re-render
      tuiDemo.TUI.enabled = true;
    }

    // Initialize with template
    tuiDemo.Model.text = fileTemplate.trim();

    // Show initial file (also creates the file list elements)
    loadFile('main.js');

    // Add a prompt at the bottom
    tuiDemo.TUI.addPrompt({
      row: 12,
      col: 18,
      width: 40,
      title: 'Command',
      onActivate: (el) => alert('Command: ' + el.input)
    });

    // Enable TUI mode by default
    tuiDemo.TUI.enabled = true;
    document.getElementById('tui-toggle-btn').textContent = 'Disable TUI Mode';

    const tuiHighlightBtn = document.getElementById('tui-highlight-toggle-btn');
    tuiHighlightBtn.classList.remove('hidden');
    tuiHighlightBtn.textContent = 'Unhighlight All';
    let tuiHighlighted = true;

    document.getElementById('tui-toggle-btn').addEventListener('click', () => {
      tuiDemo.TUI.enabled = !tuiDemo.TUI.enabled;
      document.getElementById('tui-toggle-btn').textContent = tuiDemo.TUI.enabled ? 'Disable TUI Mode' : 'Enable TUI Mode';
      tuiHighlightBtn.classList.toggle('hidden', !tuiDemo.TUI.enabled);
    });

    tuiHighlightBtn.addEventListener('click', () => {
      tuiHighlighted = !tuiHighlighted;
      tuiDemo.TUI.setHighlight(tuiHighlighted);
      tuiHighlightBtn.textContent = tuiHighlighted ? 'Unhighlight All' : 'Highlight All';
    });

    document.getElementById('tui-add-btn').addEventListener('click', () => {
      const row = parseInt(document.getElementById('tui-row').value) || 0;
      const col = parseInt(document.getElementById('tui-col').value) || 0;
      const label = document.getElementById('tui-content').value || 'Button';
      tuiDemo.TUI.addButton({ row, col, label });
    });

    // Bind Tab to nextElement, other keys to handleKeyDown in TUI mode
    tuiDemoElement.addEventListener('keydown', (e) => {
      if (!tuiDemo.TUI.enabled) return;
      if (e.key === 'Tab') {
        e.preventDefault();
        tuiDemo.TUI.nextElement();
      } else {
        e.preventDefault();
        tuiDemo.TUI.handleKeyDown(e.key);
      }
    });

    // Expose for debugging
    window.tuiDemo = tuiDemo;
  });
</script>
</body>
</html>
